{% extends "base.html" %}

{% block title %}Broadcast - MoodSprint Admin{% endblock %}
{% block header %}Broadcast{% endblock %}

{% block content %}
<div class="max-w-3xl">
    <!-- Stats -->
    <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-2xl font-bold text-gray-900">{{ total_users }}</div>
            <div class="text-sm text-gray-500">Total Users</div>
        </div>
        {% for lang, count in lang_stats.items() %}
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-2xl font-bold text-gray-900">{{ count }}</div>
            <div class="text-sm text-gray-500">{{ lang | upper }}</div>
        </div>
        {% endfor %}
    </div>

    <!-- Broadcast Form -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Send Message</h3>

        <form id="broadcastForm">
            <!-- Filter -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter</label>
                <select id="filterType" name="filter_type" class="w-full border rounded-lg px-3 py-2" onchange="updateFilterFields()">
                    <option value="all">All Users ({{ total_users }})</option>
                    <option value="language">By Language</option>
                    <option value="level">By Level Range</option>
                    <option value="activity">By Recent Activity</option>
                    <option value="user">Specific User</option>
                </select>
            </div>

            <!-- Language filter -->
            <div id="langFilter" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Language</label>
                <select name="filter_language" class="w-full border rounded-lg px-3 py-2">
                    {% for lang, count in lang_stats.items() %}
                    <option value="{{ lang }}">{{ lang | upper }} ({{ count }} users)</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Level filter -->
            <div id="levelFilter" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Level Range</label>
                <div class="flex gap-2">
                    <input type="number" name="filter_level_min" placeholder="Min level" min="1" class="flex-1 border rounded-lg px-3 py-2">
                    <span class="py-2">-</span>
                    <input type="number" name="filter_level_max" placeholder="Max level" min="1" class="flex-1 border rounded-lg px-3 py-2">
                </div>
            </div>

            <!-- Activity filter -->
            <div id="activityFilter" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Active in last N days</label>
                <input type="number" name="filter_active_days" placeholder="e.g. 7" min="1" max="365" class="w-full border rounded-lg px-3 py-2">
            </div>

            <!-- Specific user filter -->
            <div id="userFilter" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Username, name, or Telegram ID</label>
                <input type="text" name="filter_user_search" placeholder="e.g. @username or 123456789" class="w-full border rounded-lg px-3 py-2">
                <p class="text-xs text-gray-500 mt-1">Searches by username, first name, or exact Telegram ID</p>
            </div>

            <!-- Message Editor -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>

                <!-- Toolbar -->
                <div class="flex items-center gap-1 border border-b-0 rounded-t-lg bg-gray-50 px-2 py-1.5">
                    <button type="button" onclick="wrapSelection('b')" class="p-1.5 hover:bg-gray-200 rounded text-sm font-bold text-gray-700" title="Bold">
                        B
                    </button>
                    <button type="button" onclick="wrapSelection('i')" class="p-1.5 hover:bg-gray-200 rounded text-sm italic text-gray-700" title="Italic">
                        I
                    </button>
                    <button type="button" onclick="wrapSelection('u')" class="p-1.5 hover:bg-gray-200 rounded text-sm underline text-gray-700" title="Underline">
                        U
                    </button>
                    <button type="button" onclick="wrapSelection('s')" class="p-1.5 hover:bg-gray-200 rounded text-sm line-through text-gray-700" title="Strikethrough">
                        S
                    </button>
                    <div class="w-px h-5 bg-gray-300 mx-1"></div>
                    <button type="button" onclick="wrapSelection('code')" class="p-1.5 hover:bg-gray-200 rounded text-xs font-mono text-gray-700" title="Inline code">
                        &lt;/&gt;
                    </button>
                    <button type="button" onclick="wrapSelection('pre')" class="p-1.5 hover:bg-gray-200 rounded text-xs font-mono text-gray-700" title="Code block">
                        PRE
                    </button>
                    <div class="w-px h-5 bg-gray-300 mx-1"></div>
                    <button type="button" onclick="insertLink()" class="p-1.5 hover:bg-gray-200 rounded text-gray-700" title="Insert link">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                    </button>
                    <div class="flex-1"></div>
                    <span class="text-xs text-gray-400">Telegram HTML</span>
                </div>

                <textarea
                    id="messageText"
                    name="message"
                    rows="8"
                    class="w-full border border-t-0 rounded-b-lg px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Type your message here..."
                ></textarea>

                <div class="flex items-center gap-4 mt-1">
                    <p class="text-xs text-gray-500">
                        Supported: &lt;b&gt;bold&lt;/b&gt;, &lt;i&gt;italic&lt;/i&gt;, &lt;u&gt;underline&lt;/u&gt;, &lt;s&gt;strikethrough&lt;/s&gt;, &lt;code&gt;code&lt;/code&gt;, &lt;pre&gt;block&lt;/pre&gt;, &lt;a href="url"&gt;link&lt;/a&gt;
                    </p>
                </div>
            </div>

            <!-- Preview -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                <div id="preview" class="border rounded-lg p-4 bg-gray-50 min-h-[60px] text-sm whitespace-pre-wrap">
                    <span class="text-gray-400">Message preview will appear here...</span>
                </div>
            </div>

            <!-- Send -->
            <div class="flex items-center gap-4">
                <button
                    type="button"
                    id="sendBtn"
                    onclick="sendBroadcast()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-medium"
                >
                    Send Broadcast
                </button>
                <div id="sendResult" class="text-sm"></div>
            </div>
        </form>
    </div>
    <!-- Broadcast History -->
    {% if history %}
    <div class="bg-white rounded-lg shadow p-6 mt-6">
        <h3 class="text-lg font-semibold mb-4">Broadcast History</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b text-left text-gray-500">
                        <th class="pb-2 pr-4">Date</th>
                        <th class="pb-2 pr-4">Message</th>
                        <th class="pb-2 pr-4">Filter</th>
                        <th class="pb-2 pr-4 text-right">Sent</th>
                        <th class="pb-2 text-right">Failed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in history %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 pr-4 text-gray-500 whitespace-nowrap">
                            {{ item.created_at.strftime('%d.%m.%Y %H:%M') if item.created_at else '—' }}
                        </td>
                        <td class="py-3 pr-4">
                            <div class="max-w-md truncate text-gray-900" title="{{ item.message }}">
                                {{ item.message[:120] }}{% if item.message|length > 120 %}…{% endif %}
                            </div>
                        </td>
                        <td class="py-3 pr-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                {% if item.filter_type == 'all' %}bg-blue-100 text-blue-800
                                {% elif item.filter_type == 'language' %}bg-green-100 text-green-800
                                {% elif item.filter_type == 'user' %}bg-purple-100 text-purple-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ item.filter_type }}
                            </span>
                            {% if item.filter_details %}
                            <span class="text-xs text-gray-500 ml-1">{{ item.filter_details }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3 pr-4 text-right">
                            <span class="text-green-600 font-medium">{{ item.sent }}</span>
                            <span class="text-gray-400">/{{ item.total }}</span>
                        </td>
                        <td class="py-3 text-right">
                            {% if item.failed > 0 %}
                            <span class="text-red-500 font-medium">{{ item.failed }}</span>
                            {% else %}
                            <span class="text-gray-400">0</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function updateFilterFields() {
    const filterType = document.getElementById('filterType').value;
    document.getElementById('langFilter').classList.toggle('hidden', filterType !== 'language');
    document.getElementById('levelFilter').classList.toggle('hidden', filterType !== 'level');
    document.getElementById('activityFilter').classList.toggle('hidden', filterType !== 'activity');
    document.getElementById('userFilter').classList.toggle('hidden', filterType !== 'user');
}

// Toolbar functions
function wrapSelection(tag) {
    const textarea = document.getElementById('messageText');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);

    if (selected) {
        textarea.value = before + `<${tag}>` + selected + `</${tag}>` + after;
        textarea.selectionStart = start;
        textarea.selectionEnd = end + tag.length * 2 + 5;
    } else {
        textarea.value = before + `<${tag}></${tag}>` + after;
        textarea.selectionStart = start + tag.length + 2;
        textarea.selectionEnd = start + tag.length + 2;
    }
    textarea.focus();
    textarea.dispatchEvent(new Event('input'));
}

function insertLink() {
    const textarea = document.getElementById('messageText');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);

    const url = prompt('Enter URL:', 'https://');
    if (!url) return;

    const linkText = selected || prompt('Enter link text:', 'click here') || 'link';
    textarea.value = before + `<a href="${url}">${linkText}</a>` + after;
    textarea.focus();
    textarea.dispatchEvent(new Event('input'));
}

// Live preview
document.getElementById('messageText').addEventListener('input', function() {
    const preview = document.getElementById('preview');
    if (this.value.trim()) {
        // Render allowed HTML tags, escape the rest
        let html = this.value;
        // Replace newlines with <br> for display
        html = html.replace(/\n/g, '<br>');
        preview.innerHTML = html;
    } else {
        preview.innerHTML = '<span class="text-gray-400">Message preview will appear here...</span>';
    }
});

function sendBroadcast() {
    const btn = document.getElementById('sendBtn');
    const result = document.getElementById('sendResult');
    const form = document.getElementById('broadcastForm');

    const message = document.getElementById('messageText').value.trim();
    if (!message) {
        result.innerHTML = '<span class="text-red-600">Please enter a message</span>';
        return;
    }

    const filterType = document.getElementById('filterType').value;
    const filterLabel = filterType === 'user' ? 'this user' : (filterType === 'all' ? 'ALL users' : 'filtered users');

    if (!confirm(`Send this broadcast to ${filterLabel}?`)) {
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Sending...';
    result.innerHTML = '<span class="text-gray-500">Processing...</span>';

    const formData = new FormData(form);

    fetch('{{ url_for("broadcast_send") }}', {
        method: 'POST',
        body: formData,
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            result.innerHTML = `<span class="text-green-600">Sent: ${data.sent}/${data.total} (${data.failed} failed)</span>`;
        } else {
            result.innerHTML = `<span class="text-red-600">${data.error}</span>`;
        }
    })
    .catch(err => {
        result.innerHTML = `<span class="text-red-600">Error: ${err.message}</span>`;
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Send Broadcast';
    });
}

// Keyboard shortcuts in textarea
document.getElementById('messageText').addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
            case 'b': e.preventDefault(); wrapSelection('b'); break;
            case 'i': e.preventDefault(); wrapSelection('i'); break;
            case 'u': e.preventDefault(); wrapSelection('u'); break;
            case 'k': e.preventDefault(); insertLink(); break;
        }
    }
});
</script>
{% endblock %}
