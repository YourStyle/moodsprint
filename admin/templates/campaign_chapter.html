{% extends "base.html" %}

{% block title %}Chapter {{ chapter.number }} - MoodSprint Admin{% endblock %}
{% block header %}
<a href="{{ url_for('campaign') }}" class="text-purple-600 hover:text-purple-800">&larr; Back to Chapters</a>
<span class="mx-2 text-gray-400">/</span>
Chapter {{ chapter.number }}: {{ chapter.name }}
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Chapter Details -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-start justify-between mb-6">
            <div class="flex items-center gap-4">
                {% if chapter.image_url %}
                <img src="{{ chapter.image_url }}" alt="{{ chapter.name }}" class="w-20 h-20 rounded-xl object-cover">
                {% else %}
                <div class="text-5xl">{{ chapter.emoji }}</div>
                {% endif %}
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">{{ chapter.name }}</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="px-2 py-1 bg-gray-100 rounded text-sm capitalize">{{ chapter.genre }}</span>
                        {% if chapter.is_active %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">Active</span>
                        {% else %}
                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm">Inactive</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <button onclick="toggleEditMode()" id="editBtn"
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700">
                Edit Chapter
            </button>
        </div>

        <!-- Edit Form -->
        <form id="chapterForm" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" name="name" value="{{ chapter.name }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Genre</label>
                    <select name="genre" class="w-full border rounded-lg px-3 py-2">
                        {% for g in ['fantasy', 'magic', 'scifi', 'cyberpunk', 'anime'] %}
                        <option value="{{ g }}" {{ 'selected' if g == chapter.genre else '' }}>{{ g|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                    <input type="text" name="emoji" value="{{ chapter.emoji }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Background Color</label>
                    <input type="color" name="background_color" value="{{ chapter.background_color }}"
                           class="w-full h-10 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                    <input type="url" name="image_url" value="{{ chapter.image_url or '' }}"
                           class="w-full border rounded-lg px-3 py-2"
                           placeholder="https://...">
                </div>
            </div>
            {% if chapter.image_url %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Image</label>
                <img src="{{ chapter.image_url }}" alt="Preview" class="h-24 rounded-lg">
            </div>
            {% endif %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea name="description" rows="2"
                          class="w-full border rounded-lg px-3 py-2">{{ chapter.description or '' }}</textarea>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Required Power</label>
                    <input type="number" name="required_power" value="{{ chapter.required_power }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">XP Reward</label>
                    <input type="number" name="xp_reward" value="{{ chapter.xp_reward }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Card Rarity</label>
                    <select name="guaranteed_card_rarity" class="w-full border rounded-lg px-3 py-2">
                        {% for r in ['common', 'uncommon', 'rare', 'epic', 'legendary'] %}
                        <option value="{{ r }}" {{ 'selected' if r == chapter.guaranteed_card_rarity else '' }}>{{ r|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Story Intro (shown at chapter start)</label>
                <textarea name="story_intro" rows="4"
                          class="w-full border rounded-lg px-3 py-2 font-mono text-sm">{{ chapter.story_intro or '' }}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Story Outro (shown after boss defeat)</label>
                <textarea name="story_outro" rows="4"
                          class="w-full border rounded-lg px-3 py-2 font-mono text-sm">{{ chapter.story_outro or '' }}</textarea>
            </div>
            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_active" {{ 'checked' if chapter.is_active else '' }}
                           class="rounded text-purple-600">
                    <span class="text-sm text-gray-700">Active</span>
                </label>
            </div>
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button type="button" onclick="toggleEditMode()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Changes</button>
            </div>
        </form>

        <!-- View Mode -->
        <div id="chapterView" class="space-y-4">
            {% if chapter.description %}
            <p class="text-gray-600">{{ chapter.description }}</p>
            {% endif %}

            <div class="grid grid-cols-3 gap-4 text-sm">
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">Required Power</div>
                    <div class="text-lg font-semibold">{{ chapter.required_power }}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">XP Reward</div>
                    <div class="text-lg font-semibold">{{ chapter.xp_reward }}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">Card Reward</div>
                    <div class="text-lg font-semibold capitalize">{{ chapter.guaranteed_card_rarity }}</div>
                </div>
            </div>

            {% if chapter.story_intro %}
            <div class="bg-purple-50 border-l-4 border-purple-400 p-4 rounded-r">
                <div class="text-sm font-medium text-purple-800 mb-1">Story Intro</div>
                <p class="text-gray-700 whitespace-pre-wrap">{{ chapter.story_intro }}</p>
            </div>
            {% endif %}

            {% if chapter.story_outro %}
            <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r">
                <div class="text-sm font-medium text-green-800 mb-1">Story Outro</div>
                <p class="text-gray-700 whitespace-pre-wrap">{{ chapter.story_outro }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Levels -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex items-center justify-between">
            <h3 class="text-lg font-semibold">Levels ({{ levels|length }})</h3>
            <button onclick="showAddLevelModal()"
                    class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                + Add Level
            </button>
        </div>

        <div class="divide-y">
            {% for level in levels %}
            <div class="p-4 hover:bg-gray-50 flex items-center gap-4" id="level-{{ level.id }}">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg font-bold
                    {% if level.is_boss %}bg-red-100 text-red-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                    {{ level.number }}
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">{{ level.monster_emoji or '?' }}</span>
                        <span class="font-medium">{{ level.title or level.monster_name or 'Level ' + level.number|string }}</span>
                        {% if level.is_boss %}
                        <span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded">BOSS</span>
                        {% endif %}
                        {% if not level.is_active %}
                        <span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">Inactive</span>
                        {% endif %}
                    </div>
                    <div class="text-sm text-gray-500">
                        {{ level.monster_name or 'No monster' }} | +{{ level.xp_reward }} XP | Difficulty: {{ level.difficulty_multiplier }}x
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="editLevel({{ level|tojson|e }})"
                            class="text-purple-600 hover:text-purple-800 text-sm">Edit</button>
                    <button onclick="deleteLevel({{ level.id }})"
                            class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                </div>
            </div>
            {% endfor %}

            {% if not levels %}
            <div class="p-8 text-center text-gray-500">
                No levels yet. Add your first level!
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add/Edit Level Modal -->
<div id="levelModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b">
            <h3 id="levelModalTitle" class="text-lg font-semibold">Add Level</h3>
        </div>
        <form id="levelForm" class="p-4 space-y-4">
            <input type="hidden" name="level_id" value="">

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" name="title"
                           class="w-full border rounded-lg px-3 py-2"
                           placeholder="Level title (optional)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monster</label>
                    <select name="monster_id" class="w-full border rounded-lg px-3 py-2">
                        <option value="">Select monster...</option>
                        {% for monster in all_monsters %}
                        <option value="{{ monster.id }}">{{ monster.emoji }} {{ monster.name }} ({{ monster.genre }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Difficulty Multiplier</label>
                    <input type="number" step="0.1" name="difficulty_multiplier" value="1.0"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">XP Reward</label>
                    <input type="number" name="xp_reward" value="50"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Stars</label>
                    <select name="stars_max" class="w-full border rounded-lg px-3 py-2">
                        <option value="1">1 Star</option>
                        <option value="2">2 Stars</option>
                        <option value="3" selected>3 Stars</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_boss" class="rounded text-red-600">
                    <span class="text-sm text-gray-700">Boss Level</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_active" checked class="rounded text-purple-600">
                    <span class="text-sm text-gray-700">Active</span>
                </label>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Dialogue Before Battle (JSON array)
                </label>
                <textarea name="dialogue_before" rows="4"
                          class="w-full border rounded-lg px-3 py-2 font-mono text-sm"
                          placeholder='[{"speaker": "Monster", "text": "You dare challenge me?", "emoji": "ðŸ‘¹"}]'></textarea>
                <p class="text-xs text-gray-500 mt-1">Format: [{"speaker": "Name", "text": "...", "emoji": "..."}]</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Dialogue After Battle (JSON array)
                </label>
                <textarea name="dialogue_after" rows="4"
                          class="w-full border rounded-lg px-3 py-2 font-mono text-sm"
                          placeholder='[{"speaker": "Hero", "text": "Victory!", "emoji": "ðŸŽ‰"}]'></textarea>
            </div>
        </form>
        <div class="p-4 border-t flex justify-end gap-2">
            <button onclick="hideLevelModal()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onclick="saveLevel()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const chapterId = {{ chapter.id }};

function toggleEditMode() {
    const form = document.getElementById('chapterForm');
    const view = document.getElementById('chapterView');
    const btn = document.getElementById('editBtn');

    if (form.classList.contains('hidden')) {
        form.classList.remove('hidden');
        view.classList.add('hidden');
        btn.textContent = 'Cancel';
    } else {
        form.classList.add('hidden');
        view.classList.remove('hidden');
        btn.textContent = 'Edit Chapter';
    }
}

document.getElementById('chapterForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    data.is_active = formData.has('is_active');
    data.required_power = parseInt(data.required_power) || 0;
    data.xp_reward = parseInt(data.xp_reward) || 500;

    try {
        const response = await fetch(`/campaign/chapters/${chapterId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
});

// Level Modal Functions
function showAddLevelModal() {
    document.getElementById('levelModalTitle').textContent = 'Add Level';
    document.getElementById('levelForm').reset();
    document.querySelector('[name="level_id"]').value = '';
    document.getElementById('levelModal').classList.remove('hidden');
}

function hideLevelModal() {
    document.getElementById('levelModal').classList.add('hidden');
}

function editLevel(level) {
    document.getElementById('levelModalTitle').textContent = 'Edit Level ' + level.number;
    document.querySelector('[name="level_id"]').value = level.id;
    document.querySelector('[name="title"]').value = level.title || '';
    document.querySelector('[name="monster_id"]').value = level.monster_id || '';
    document.querySelector('[name="difficulty_multiplier"]').value = level.difficulty_multiplier;
    document.querySelector('[name="xp_reward"]').value = level.xp_reward;
    document.querySelector('[name="stars_max"]').value = level.stars_max;
    document.querySelector('[name="is_boss"]').checked = level.is_boss;
    document.querySelector('[name="is_active"]').checked = level.is_active;
    document.querySelector('[name="dialogue_before"]').value =
        level.dialogue_before ? JSON.stringify(level.dialogue_before, null, 2) : '';
    document.querySelector('[name="dialogue_after"]').value =
        level.dialogue_after ? JSON.stringify(level.dialogue_after, null, 2) : '';
    document.getElementById('levelModal').classList.remove('hidden');
}

async function saveLevel() {
    const form = document.getElementById('levelForm');
    const formData = new FormData(form);
    const levelId = formData.get('level_id');
    const data = Object.fromEntries(formData.entries());

    data.monster_id = data.monster_id ? parseInt(data.monster_id) : null;
    data.difficulty_multiplier = parseFloat(data.difficulty_multiplier) || 1.0;
    data.xp_reward = parseInt(data.xp_reward) || 50;
    data.stars_max = parseInt(data.stars_max) || 3;
    data.is_boss = formData.has('is_boss');
    data.is_active = formData.has('is_active');

    // Parse JSON fields
    try {
        data.dialogue_before = data.dialogue_before ? JSON.parse(data.dialogue_before) : null;
    } catch (e) {
        alert('Invalid JSON in Dialogue Before');
        return;
    }
    try {
        data.dialogue_after = data.dialogue_after ? JSON.parse(data.dialogue_after) : null;
    } catch (e) {
        alert('Invalid JSON in Dialogue After');
        return;
    }

    delete data.level_id;

    const url = levelId
        ? `/campaign/levels/${levelId}/update`
        : `/campaign/chapters/${chapterId}/levels/new`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function deleteLevel(levelId) {
    if (!confirm('Are you sure you want to delete this level?')) return;

    try {
        const response = await fetch(`/campaign/levels/${levelId}/delete`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            document.getElementById('level-' + levelId).remove();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Close modal on backdrop click
document.getElementById('levelModal').addEventListener('click', function(e) {
    if (e.target === this) hideLevelModal();
});
</script>
{% endblock %}
