{% extends "base.html" %}

{% block title %}Chapter {{ chapter.number }} - MoodSprint Admin{% endblock %}
{% block header %}
<a href="{{ url_for('campaign') }}" class="text-purple-600 hover:text-purple-800">&larr; Back to Chapters</a>
<span class="mx-2 text-gray-400">/</span>
Chapter {{ chapter.number }}: {{ chapter.name }}
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Chapter Details -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-start justify-between mb-6">
            <div class="flex items-center gap-4">
                {% if chapter.image_url %}
                <img src="{{ chapter.image_url }}" alt="{{ chapter.name }}" class="w-20 h-20 rounded-xl object-cover">
                {% else %}
                <div class="text-5xl">{{ chapter.emoji }}</div>
                {% endif %}
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">{{ chapter.name }}</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="px-2 py-1 bg-gray-100 rounded text-sm capitalize">{{ chapter.genre }}</span>
                        {% if chapter.is_active %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">Active</span>
                        {% else %}
                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm">Inactive</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <button onclick="toggleEditMode()" id="editBtn"
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700">
                Edit Chapter
            </button>
        </div>

        <!-- Edit Form -->
        <form id="chapterForm" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" name="name" value="{{ chapter.name }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Genre</label>
                    <select name="genre" class="w-full border rounded-lg px-3 py-2">
                        {% for g in ['fantasy', 'magic', 'scifi', 'cyberpunk', 'anime'] %}
                        <option value="{{ g }}" {{ 'selected' if g == chapter.genre else '' }}>{{ g|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                    <input type="text" name="emoji" value="{{ chapter.emoji }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Background Color</label>
                    <input type="color" name="background_color" value="{{ chapter.background_color }}"
                           class="w-full h-10 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                    <div class="flex gap-2">
                        <input type="url" name="image_url" value="{{ chapter.image_url or '' }}"
                               class="flex-1 border rounded-lg px-3 py-2"
                               placeholder="https://...">
                        <button type="button" onclick="generateChapterImage()"
                                class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm whitespace-nowrap"
                                title="Generate image with AI">
                            üé® AI
                        </button>
                    </div>
                </div>
            </div>
            {% if chapter.image_url %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Image</label>
                <img src="{{ chapter.image_url }}" alt="Preview" class="h-24 rounded-lg">
            </div>
            {% endif %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea name="description" rows="2"
                          class="w-full border rounded-lg px-3 py-2">{{ chapter.description or '' }}</textarea>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Required Power</label>
                    <input type="number" name="required_power" value="{{ chapter.required_power }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">XP Reward</label>
                    <input type="number" name="xp_reward" value="{{ chapter.xp_reward }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Card Rarity</label>
                    <select name="guaranteed_card_rarity" class="w-full border rounded-lg px-3 py-2">
                        {% for r in ['common', 'uncommon', 'rare', 'epic', 'legendary'] %}
                        <option value="{{ r }}" {{ 'selected' if r == chapter.guaranteed_card_rarity else '' }}>{{ r|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Story Intro (shown at chapter start)</label>
                <textarea name="story_intro" rows="4"
                          class="w-full border rounded-lg px-3 py-2 font-mono text-sm">{{ chapter.story_intro or '' }}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Story Outro (shown after boss defeat)</label>
                <textarea name="story_outro" rows="4"
                          class="w-full border rounded-lg px-3 py-2 font-mono text-sm">{{ chapter.story_outro or '' }}</textarea>
            </div>
            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_active" {{ 'checked' if chapter.is_active else '' }}
                           class="rounded text-purple-600">
                    <span class="text-sm text-gray-700">Active</span>
                </label>
            </div>
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button type="button" onclick="toggleEditMode()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Changes</button>
            </div>
        </form>

        <!-- View Mode -->
        <div id="chapterView" class="space-y-4">
            {% if chapter.description %}
            <p class="text-gray-600">{{ chapter.description }}</p>
            {% endif %}

            <div class="grid grid-cols-3 gap-4 text-sm">
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">Required Power</div>
                    <div class="text-lg font-semibold">{{ chapter.required_power }}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">XP Reward</div>
                    <div class="text-lg font-semibold">{{ chapter.xp_reward }}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">Card Reward</div>
                    <div class="text-lg font-semibold capitalize">{{ chapter.guaranteed_card_rarity }}</div>
                </div>
            </div>

            {% if chapter.story_intro %}
            <div class="bg-purple-50 border-l-4 border-purple-400 p-4 rounded-r">
                <div class="text-sm font-medium text-purple-800 mb-1">Story Intro</div>
                <p class="text-gray-700 whitespace-pre-wrap">{{ chapter.story_intro }}</p>
            </div>
            {% endif %}

            {% if chapter.story_outro %}
            <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r">
                <div class="text-sm font-medium text-green-800 mb-1">Story Outro</div>
                <p class="text-gray-700 whitespace-pre-wrap">{{ chapter.story_outro }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Levels -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex items-center justify-between">
            <h3 class="text-lg font-semibold">Levels ({{ levels|length }})</h3>
            <div class="flex gap-2">
                <button onclick="bulkImportLevels()"
                        class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700"
                        title="Import multiple JSON files at once">
                    üì¶ Bulk Import
                </button>
                <button onclick="showAddLevelModal()"
                        class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                    + Add Level
                </button>
            </div>
        </div>

        <div class="divide-y">
            {% for level in levels %}
            <div class="p-4 hover:bg-gray-50 flex items-center gap-4" id="level-{{ level.id }}">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg font-bold
                    {% if level.is_boss %}bg-red-100 text-red-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                    {{ level.number }}
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">{{ level.monster_emoji or '?' }}</span>
                        <span class="font-medium">{{ level.title or level.monster_name or 'Level ' + level.number|string }}</span>
                        {% if level.is_boss %}
                        <span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded">BOSS</span>
                        {% endif %}
                        {% if level.is_final %}
                        <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">FINAL</span>
                        {% endif %}
                        {% if not level.is_active %}
                        <span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">Inactive</span>
                        {% endif %}
                    </div>
                    <div class="text-sm text-gray-500">
                        {{ level.monster_name or 'No monster' }} | +{{ level.xp_reward }} XP | Difficulty: {{ level.difficulty_multiplier }}x
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportLevelJson({{ level.id }})"
                            class="text-blue-600 hover:text-blue-800 text-sm" title="Export JSON template">üì§</button>
                    <button onclick="importLevelJson({{ level.id }})"
                            class="text-green-600 hover:text-green-800 text-sm" title="Import JSON">üì•</button>
                    <button onclick="editLevelById({{ level.id }})"
                            class="text-purple-600 hover:text-purple-800 text-sm">Edit</button>
                    <button onclick="deleteLevel({{ level.id }})"
                            class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                </div>
            </div>
            {% endfor %}

            {% if not levels %}
            <div class="p-8 text-center text-gray-500">
                No levels yet. Add your first level!
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Rewards -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex items-center justify-between">
            <h3 class="text-lg font-semibold">Chapter Rewards ({{ rewards|length }})</h3>
            <button onclick="showAddRewardModal()"
                    class="px-3 py-1.5 bg-amber-600 text-white text-sm rounded-lg hover:bg-amber-700">
                + Add Reward
            </button>
        </div>

        <div class="divide-y">
            {% for reward in rewards %}
            <div class="p-4 hover:bg-gray-50 flex items-center gap-4" id="reward-{{ reward.id }}">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg bg-amber-100 text-amber-600">
                    {{ reward.emoji or 'üéÅ' }}
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="font-medium">{{ reward.name or 'Unnamed Reward' }}</span>
                        <span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded capitalize">{{ reward.reward_type }}</span>
                    </div>
                    <div class="text-sm text-gray-500">
                        {% if reward.reward_type == 'sparks' %}
                            {{ reward.reward_data.amount if reward.reward_data else 100 }} ‚ú® Sparks
                        {% elif reward.reward_type == 'xp' %}
                            {{ reward.reward_data.amount if reward.reward_data else 500 }} XP
                        {% elif reward.reward_type == 'card' %}
                            {{ reward.reward_data.rarity if reward.reward_data else 'rare' }} card
                        {% else %}
                            {{ reward.description or '' }}
                        {% endif %}
                    </div>
                </div>
                <button onclick="deleteReward({{ reward.id }})"
                        class="text-red-600 hover:text-red-800 text-sm">Delete</button>
            </div>
            {% endfor %}

            {% if not rewards %}
            <div class="p-8 text-center text-gray-500">
                No rewards yet. Add your first reward!
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add/Edit Level Modal -->
<div id="levelModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b">
            <h3 id="levelModalTitle" class="text-lg font-semibold">Add Level</h3>
        </div>
        <form id="levelForm" class="p-4 space-y-4">
            <input type="hidden" name="level_id" value="">

            <!-- AI Generate Button -->
            <div>
                <button type="button" onclick="generateLevel()"
                        class="w-full px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 flex items-center justify-center gap-2">
                    ü§ñ Generate name & monster with AI
                </button>
                <div id="levelGenerationStatus" class="text-xs text-gray-500 mt-1 hidden"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" name="title"
                           class="w-full border rounded-lg px-3 py-2"
                           placeholder="Level title (optional)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monster</label>
                    <select name="monster_id" class="w-full border rounded-lg px-3 py-2">
                        <option value="">Select monster...</option>
                        {% for monster in all_monsters %}
                        <option value="{{ monster.id }}">{{ monster.emoji }} {{ monster.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Difficulty Multiplier</label>
                    <input type="number" step="0.1" name="difficulty_multiplier" value="1.0"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">XP Reward</label>
                    <input type="number" name="xp_reward" value="50"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Stars</label>
                    <input type="number" name="stars_max" value="3" min="1" max="10"
                        class="w-full border rounded-lg px-3 py-2">
                </div>
            </div>

            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_boss" class="rounded text-red-600">
                    <span class="text-sm text-gray-700">Boss Level</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_final" class="rounded text-green-600">
                    <span class="text-sm text-gray-700">Final Level</span>
                    <span class="text-xs text-gray-400" title="Completing this level ends the chapter and shows outro">(ends chapter)</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_active" checked class="rounded text-purple-600">
                    <span class="text-sm text-gray-700">Active</span>
                </label>
            </div>

            <!-- Dialogue Before Battle -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-gray-700">Dialogue Before Battle</label>
                    <button type="button" onclick="openDialogBuilder('before')"
                            class="text-purple-600 hover:text-purple-800 text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Visual Editor
                    </button>
                </div>
                <div id="dialogBeforePreview" class="bg-gray-50 rounded-lg p-3 min-h-[60px] text-sm text-gray-600">
                    No dialogue configured
                </div>
                <input type="hidden" name="dialogue_before" value="">
            </div>

            <!-- Dialogue After Battle -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-gray-700">Dialogue After Battle</label>
                    <button type="button" onclick="openDialogBuilder('after')"
                            class="text-purple-600 hover:text-purple-800 text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Visual Editor
                    </button>
                </div>
                <div id="dialogAfterPreview" class="bg-gray-50 rounded-lg p-3 min-h-[60px] text-sm text-gray-600">
                    No dialogue configured
                </div>
                <input type="hidden" name="dialogue_after" value="">
            </div>

            <!-- Star Conditions -->
            <div class="border-t pt-4 mt-4">
                <div class="flex items-center justify-between mb-3">
                    <label class="block text-sm font-medium text-gray-700">Star Conditions</label>
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="useCustomStars" onchange="toggleStarConditions()" class="rounded text-purple-600">
                        <span class="text-gray-600">Custom conditions</span>
                    </label>
                </div>
                <div id="starConditionsDefault" class="bg-gray-50 rounded-lg p-3 text-sm text-gray-600">
                    <p class="font-medium mb-2">Default conditions:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>1‚≠ê base for winning</li>
                        <li>+1‚≠ê if rounds ‚â§ 5, +0.5‚≠ê if ‚â§ 10</li>
                        <li>+1‚≠ê if no cards lost, +0.5‚≠ê if 1 card</li>
                    </ul>
                </div>
                <div id="starConditionsCustom" class="hidden space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Base stars (for winning)</label>
                            <input type="number" name="star_base" value="1" min="0" max="3" step="0.5"
                                   class="w-full border rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                    <div id="starConditionsList" class="space-y-2">
                        <!-- Conditions will be rendered here -->
                    </div>
                    <button type="button" onclick="addStarCondition()"
                            class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-purple-400 hover:text-purple-600 text-sm">
                        + Add Condition
                    </button>
                </div>
                <input type="hidden" name="star_conditions" value="">
            </div>
        </form>
        <div class="p-4 border-t flex justify-end gap-2">
            <button onclick="hideLevelModal()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onclick="saveLevel()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save</button>
        </div>
    </div>
</div>

<!-- Dialog Builder Modal -->
<div id="dialogBuilderModal" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col">
        <div class="p-4 border-b flex items-center justify-between">
            <h3 id="dialogBuilderTitle" class="text-lg font-semibold">Dialog Builder</h3>
            <button onclick="closeDialogBuilder()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
            <!-- Dialog Nodes -->
            <div id="dialogNodes" class="space-y-4">
                <!-- Nodes will be rendered here -->
            </div>

            <!-- Add Node Button -->
            <div class="mt-4 flex gap-2">
                <button onclick="addDialogNode()" class="flex-1 py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-purple-400 hover:text-purple-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                </button>
                <button onclick="generateDialogueWithAI()" id="aiGenerateBtn" class="px-4 py-3 border-2 border-dashed border-purple-300 rounded-lg text-purple-500 hover:border-purple-500 hover:text-purple-700 hover:bg-purple-50 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    ü§ñ AI –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
                </button>
            </div>
        </div>

        <div class="p-4 border-t flex justify-end gap-2">
            <button onclick="closeDialogBuilder()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onclick="saveDialogBuilder()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Dialogue</button>
        </div>
    </div>
</div>

<!-- Dialog Node Template -->
<template id="dialogNodeTemplate">
    <div class="dialog-node bg-white border rounded-lg p-4 shadow-sm" data-node-id="">
        <div class="flex items-start gap-4">
            <!-- Speaker Section -->
            <div class="flex-shrink-0">
                <select class="node-speaker border rounded-lg px-3 py-2 text-sm w-32" onchange="updateNodePreview(this)">
                    <option value="Monster">üëπ –ú–æ–Ω—Å—Ç—Ä</option>
                    <option value="Hero">ü¶∏ –ì–µ—Ä–æ–π</option>
                    <option value="Narrator">üìñ –†–∞—Å—Å–∫–∞–∑—á–∏–∫</option>
                    <option value="Custom">‚úèÔ∏è –°–≤–æ–π...</option>
                </select>
                <input type="text" class="node-custom-speaker hidden mt-2 border rounded-lg px-3 py-2 text-sm w-32" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
            </div>

            <!-- Content Section -->
            <div class="flex-1 space-y-3">
                <!-- Emoji & Text -->
                <div class="flex gap-2">
                    <input type="text" class="node-emoji border rounded-lg px-3 py-2 text-center w-14" value="üëπ" maxlength="4">
                    <textarea class="node-text flex-1 border rounded-lg px-3 py-2 resize-none" rows="2" placeholder="What does this character say?"></textarea>
                </div>

                <!-- Choices Section (for branching) -->
                <div class="node-choices-section hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Player Choices</span>
                        <button type="button" onclick="addChoice(this)" class="text-purple-600 hover:text-purple-800 text-xs">+ Add Choice</button>
                    </div>
                    <div class="node-choices space-y-2">
                        <!-- Choices will be added here -->
                    </div>
                </div>

                <!-- Event Section -->
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="node-has-choices rounded text-purple-600" onchange="toggleChoices(this)">
                        <span class="text-sm text-gray-600">Has player choices</span>
                    </label>
                    <select class="node-event border rounded-lg px-2 py-1 text-sm">
                        <option value="">No event</option>
                        <option value="start_battle">Start Battle</option>
                        <option value="skip_battle">Skip Battle (monster surrenders)</option>
                        <option value="buff_player">Buff Player (+20% ATK)</option>
                        <option value="debuff_monster">Weaken Monster (-20% HP)</option>
                        <option value="bonus_xp">Bonus XP (+50)</option>
                        <option value="heal_cards">Heal All Cards</option>
                    </select>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col gap-1">
                <button type="button" onclick="moveNodeUp(this)" class="p-1 text-gray-400 hover:text-gray-600" title="Move up">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                </button>
                <button type="button" onclick="moveNodeDown(this)" class="p-1 text-gray-400 hover:text-gray-600" title="Move down">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <button type="button" onclick="removeNode(this)" class="p-1 text-red-400 hover:text-red-600" title="Delete">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Choice Template -->
<template id="choiceTemplate">
    <div class="choice-item flex items-center gap-2 bg-gray-50 rounded-lg p-2">
        <span class="text-gray-400">‚Üí</span>
        <input type="text" class="choice-text flex-1 border rounded px-2 py-1 text-sm" placeholder="Choice text...">
        <select class="choice-next border rounded px-2 py-1 text-sm">
            <option value="">Continue to next</option>
            <option value="_end">End dialogue</option>
            <option value="_battle">Start battle</option>
            <option value="_skip">Skip battle</option>
        </select>
        <button type="button" onclick="removeChoice(this)" class="text-red-400 hover:text-red-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</template>

<!-- Add Reward Modal -->
<div id="rewardModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="p-4 border-b">
            <h3 class="text-lg font-semibold">Add Reward</h3>
        </div>
        <form id="rewardForm" class="p-4 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Reward Type</label>
                <select name="reward_type" onchange="updateRewardFields(this)" class="w-full border rounded-lg px-3 py-2">
                    <option value="sparks">‚ú® Sparks</option>
                    <option value="xp">‚≠ê XP</option>
                    <option value="card">üé¥ Card</option>
                </select>
            </div>

            <div id="sparksFields">
                <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                <input type="number" name="sparks_amount" value="100" min="1"
                       class="w-full border rounded-lg px-3 py-2">
            </div>

            <div id="xpFields" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">XP Amount</label>
                <input type="number" name="xp_amount" value="500" min="1"
                       class="w-full border rounded-lg px-3 py-2">
            </div>

            <div id="cardFields" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">Card Rarity</label>
                <select name="card_rarity" class="w-full border rounded-lg px-3 py-2">
                    <option value="common">Common</option>
                    <option value="uncommon">Uncommon</option>
                    <option value="rare" selected>Rare</option>
                    <option value="epic">Epic</option>
                    <option value="legendary">Legendary</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" name="name" placeholder="Reward name"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                    <input type="text" name="emoji" value="‚ú®" maxlength="4"
                           class="w-full border rounded-lg px-3 py-2 text-center">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                <input type="text" name="description" placeholder="Reward description"
                       class="w-full border rounded-lg px-3 py-2">
            </div>
        </form>
        <div class="p-4 border-t flex justify-end gap-2">
            <button onclick="hideRewardModal()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onclick="saveReward()"
                    class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700">Save</button>
        </div>
    </div>
</div>

<!-- Safely store levels data -->
<script type="application/json" id="levelsDataJson">{{ levels|tojson }}</script>
{% endblock %}

{% block scripts %}
<script>
const chapterId = {{ chapter.id }};

// Parse levels data from JSON script tag
const levelsData = JSON.parse(document.getElementById('levelsDataJson').textContent || '[]');

function editLevelById(levelId) {
    const level = levelsData.find(l => l.id === levelId);
    if (level) {
        editLevel(level);
    } else {
        alert('Level not found: ' + levelId);
    }
}

function toggleEditMode() {
    const form = document.getElementById('chapterForm');
    const view = document.getElementById('chapterView');
    const btn = document.getElementById('editBtn');

    if (form.classList.contains('hidden')) {
        form.classList.remove('hidden');
        view.classList.add('hidden');
        btn.textContent = 'Cancel';
    } else {
        form.classList.add('hidden');
        view.classList.remove('hidden');
        btn.textContent = 'Edit Chapter';
    }
}

document.getElementById('chapterForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    data.is_active = formData.has('is_active');
    data.required_power = parseInt(data.required_power) || 0;
    data.xp_reward = parseInt(data.xp_reward) || 500;

    try {
        const response = await fetch(`/campaign/chapters/${chapterId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
});

// Level Modal Functions
function showAddLevelModal() {
    document.getElementById('levelModalTitle').textContent = 'Add Level';
    document.getElementById('levelForm').reset();
    document.querySelector('[name="level_id"]').value = '';
    // Reset star conditions
    loadStarConditions(null);
    document.getElementById('levelModal').classList.remove('hidden');
}

function hideLevelModal() {
    document.getElementById('levelModal').classList.add('hidden');
}

function editLevel(level) {
    document.getElementById('levelModalTitle').textContent = 'Edit Level ' + level.number;
    document.querySelector('[name="level_id"]').value = level.id;
    document.querySelector('[name="title"]').value = level.title || '';
    document.querySelector('[name="monster_id"]').value = level.monster_id || '';
    document.querySelector('[name="difficulty_multiplier"]').value = level.difficulty_multiplier;
    document.querySelector('[name="xp_reward"]').value = level.xp_reward;
    document.querySelector('[name="stars_max"]').value = level.stars_max;
    document.querySelector('[name="is_boss"]').checked = level.is_boss;
    document.querySelector('[name="is_final"]').checked = level.is_final;
    document.querySelector('[name="is_active"]').checked = level.is_active;
    document.querySelector('[name="dialogue_before"]').value =
        level.dialogue_before ? JSON.stringify(level.dialogue_before, null, 2) : '';
    document.querySelector('[name="dialogue_after"]').value =
        level.dialogue_after ? JSON.stringify(level.dialogue_after, null, 2) : '';

    // Load star conditions
    loadStarConditions(level.star_conditions);

    document.getElementById('levelModal').classList.remove('hidden');
}

// Star Conditions Functions
let starConditions = [];

function toggleStarConditions() {
    const useCustom = document.getElementById('useCustomStars').checked;
    document.getElementById('starConditionsDefault').classList.toggle('hidden', useCustom);
    document.getElementById('starConditionsCustom').classList.toggle('hidden', !useCustom);
}

function loadStarConditions(conditions) {
    const useCustom = conditions !== null && conditions !== undefined;
    document.getElementById('useCustomStars').checked = useCustom;
    toggleStarConditions();

    if (useCustom && conditions) {
        document.querySelector('[name="star_base"]').value = conditions.base || 1;
        starConditions = conditions.conditions || [];
    } else {
        document.querySelector('[name="star_base"]').value = 1;
        starConditions = [];
    }
    renderStarConditions();
}

function renderStarConditions() {
    const container = document.getElementById('starConditionsList');
    container.innerHTML = starConditions.map((cond, idx) => `
        <div class="flex gap-2 items-center bg-gray-50 p-2 rounded-lg">
            <select onchange="updateStarCondition(${idx}, 'type', this.value)" class="border rounded px-2 py-1 text-sm flex-1">
                <option value="rounds_max" ${cond.type === 'rounds_max' ? 'selected' : ''}>Rounds ‚â§</option>
                <option value="cards_lost_max" ${cond.type === 'cards_lost_max' ? 'selected' : ''}>Cards lost ‚â§</option>
                <option value="hp_remaining_min" ${cond.type === 'hp_remaining_min' ? 'selected' : ''}>HP remaining ‚â•</option>
            </select>
            <input type="number" value="${cond.value}" onchange="updateStarCondition(${idx}, 'value', this.value)"
                   class="w-16 border rounded px-2 py-1 text-sm" placeholder="Value">
            <span class="text-gray-500 text-sm">‚Üí</span>
            <input type="number" value="${cond.stars}" onchange="updateStarCondition(${idx}, 'stars', this.value)"
                   class="w-16 border rounded px-2 py-1 text-sm" placeholder="Stars" step="0.5" min="0" max="3">
            <span class="text-gray-500 text-sm">‚≠ê</span>
            <button type="button" onclick="removeStarCondition(${idx})" class="text-red-500 hover:text-red-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `).join('');
}

function addStarCondition() {
    starConditions.push({ type: 'rounds_max', value: 5, stars: 1 });
    renderStarConditions();
}

function updateStarCondition(idx, field, value) {
    if (field === 'value' || field === 'stars') {
        starConditions[idx][field] = parseFloat(value) || 0;
    } else {
        starConditions[idx][field] = value;
    }
}

function removeStarCondition(idx) {
    starConditions.splice(idx, 1);
    renderStarConditions();
}

function getStarConditionsData() {
    const useCustom = document.getElementById('useCustomStars').checked;
    if (!useCustom) return null;

    return {
        base: parseFloat(document.querySelector('[name="star_base"]').value) || 1,
        conditions: starConditions
    };
}

async function saveLevel() {
    const form = document.getElementById('levelForm');
    const formData = new FormData(form);
    const levelId = formData.get('level_id');
    const data = Object.fromEntries(formData.entries());

    data.monster_id = data.monster_id ? parseInt(data.monster_id) : null;
    data.difficulty_multiplier = parseFloat(data.difficulty_multiplier) || 1.0;
    data.xp_reward = parseInt(data.xp_reward) || 50;
    data.stars_max = parseInt(data.stars_max) || 3;
    data.is_boss = formData.has('is_boss');
    data.is_final = formData.has('is_final');
    data.is_active = formData.has('is_active');

    // Parse JSON fields
    try {
        data.dialogue_before = data.dialogue_before ? JSON.parse(data.dialogue_before) : null;
    } catch (e) {
        alert('Invalid JSON in Dialogue Before');
        return;
    }
    try {
        data.dialogue_after = data.dialogue_after ? JSON.parse(data.dialogue_after) : null;
    } catch (e) {
        alert('Invalid JSON in Dialogue After');
        return;
    }

    // Get star conditions
    data.star_conditions = getStarConditionsData();

    delete data.level_id;
    delete data.star_base;

    const url = levelId
        ? `/campaign/levels/${levelId}/update`
        : `/campaign/chapters/${chapterId}/levels/new`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function deleteLevel(levelId) {
    if (!confirm('Are you sure you want to delete this level?')) return;

    try {
        const response = await fetch(`/campaign/levels/${levelId}/delete`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            document.getElementById('level-' + levelId).remove();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ============ Export/Import JSON ============
async function exportLevelJson(levelId) {
    try {
        const response = await fetch(`/campaign/levels/${levelId}/export`);
        const result = await response.json();

        if (result.success === false) {
            alert('Error: ' + result.error);
            return;
        }

        // Create and download JSON file
        const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `level_${levelId}_template.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function importLevelJson(levelId) {
    // Create hidden file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            const data = JSON.parse(text);

            // If the JSON has level_to_fill structure, extract it
            const levelData = data.level_to_fill || data;

            const response = await fetch(`/campaign/levels/${levelId}/import`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(levelData)
            });
            const result = await response.json();

            if (result.success) {
                alert('Level updated successfully!');
                window.location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (e) {
            alert('Error parsing JSON: ' + e.message);
        }
    };
    input.click();
}

// Bulk import multiple JSON files as new levels
function bulkImportLevels() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.multiple = true;  // Allow multiple file selection
    input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        // Sort files by name to maintain order
        files.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

        const levelsData = [];
        const errors = [];

        // Parse all files
        for (const file of files) {
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                // Extract level_to_fill if present
                const levelData = data.level_to_fill || data;
                levelsData.push(levelData);
            } catch (err) {
                errors.push(`${file.name}: ${err.message}`);
            }
        }

        if (errors.length > 0) {
            alert('Errors parsing files:\n' + errors.join('\n'));
            if (levelsData.length === 0) return;
            if (!confirm(`Continue with ${levelsData.length} valid files?`)) return;
        }

        if (levelsData.length === 0) {
            alert('No valid JSON files to import');
            return;
        }

        // Show confirmation
        const fileNames = files.map(f => f.name).join('\n');
        if (!confirm(`Import ${levelsData.length} levels in this order?\n\n${fileNames}`)) {
            return;
        }

        try {
            const response = await fetch(`/campaign/chapters/${chapterId}/levels/bulk-import`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(levelsData)
            });
            const result = await response.json();

            if (result.success) {
                alert(`Successfully created ${result.ids.length} levels!`);
                window.location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    };
    input.click();
}

// Close modal on backdrop click
document.getElementById('levelModal').addEventListener('click', function(e) {
    if (e.target === this) hideLevelModal();
});

// ============ Dialog Builder ============
let currentDialogType = null; // 'before' or 'after'
let dialogData = { before: [], after: [] };

function openDialogBuilder(type) {
    currentDialogType = type;
    document.getElementById('dialogBuilderTitle').textContent =
        type === 'before' ? 'Dialogue Before Battle' : 'Dialogue After Battle';

    // Load existing data
    const input = document.querySelector(`[name="dialogue_${type}"]`);
    try {
        dialogData[type] = input.value ? JSON.parse(input.value) : [];
    } catch (e) {
        dialogData[type] = [];
    }

    renderDialogNodes();
    document.getElementById('dialogBuilderModal').classList.remove('hidden');
}

function closeDialogBuilder() {
    document.getElementById('dialogBuilderModal').classList.add('hidden');
    currentDialogType = null;
}

function renderDialogNodes() {
    const container = document.getElementById('dialogNodes');
    container.innerHTML = '';

    if (dialogData[currentDialogType].length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No dialogue lines yet. Click "Add Dialogue Line" to start.</p>';
        return;
    }

    dialogData[currentDialogType].forEach((node, index) => {
        const template = document.getElementById('dialogNodeTemplate');
        const clone = template.content.cloneNode(true);
        const nodeEl = clone.querySelector('.dialog-node');

        nodeEl.dataset.nodeId = index;

        // Set speaker
        const speakerSelect = nodeEl.querySelector('.node-speaker');
        const customSpeaker = nodeEl.querySelector('.node-custom-speaker');
        if (['Monster', 'Hero', 'Narrator'].includes(node.speaker)) {
            speakerSelect.value = node.speaker;
        } else {
            speakerSelect.value = 'Custom';
            customSpeaker.classList.remove('hidden');
            customSpeaker.value = node.speaker || '';
        }

        // Set emoji and text
        nodeEl.querySelector('.node-emoji').value = node.emoji || 'üëπ';
        nodeEl.querySelector('.node-text').value = node.text || '';

        // Set event
        if (node.event) {
            nodeEl.querySelector('.node-event').value = node.event;
        }

        // Set choices
        if (node.choices && node.choices.length > 0) {
            nodeEl.querySelector('.node-has-choices').checked = true;
            const choicesSection = nodeEl.querySelector('.node-choices-section');
            choicesSection.classList.remove('hidden');
            const choicesContainer = nodeEl.querySelector('.node-choices');

            node.choices.forEach(choice => {
                const choiceTemplate = document.getElementById('choiceTemplate');
                const choiceClone = choiceTemplate.content.cloneNode(true);
                choiceClone.querySelector('.choice-text').value = choice.text || '';
                choiceClone.querySelector('.choice-next').value = choice.next || '';
                choicesContainer.appendChild(choiceClone);
            });
        }

        container.appendChild(clone);
    });
}

function addDialogNode() {
    // IMPORTANT: Save current data from DOM before adding new node
    const existingData = collectDialogData();
    dialogData[currentDialogType] = existingData;

    const defaultEmoji = currentDialogType === 'before' ? 'üëπ' : 'üéâ';
    const defaultSpeaker = currentDialogType === 'before' ? 'Monster' : 'Hero';

    dialogData[currentDialogType].push({
        speaker: defaultSpeaker,
        text: '',
        emoji: defaultEmoji
    });

    renderDialogNodes();

    // Scroll to new node and focus on text field
    const container = document.getElementById('dialogNodes');
    const lastNode = container.lastElementChild;
    if (lastNode) {
        lastNode.scrollIntoView({ behavior: 'smooth' });
        setTimeout(() => {
            lastNode.querySelector('.node-text')?.focus();
        }, 100);
    }
}

function removeNode(btn) {
    // Save current data first
    dialogData[currentDialogType] = collectDialogData();

    const node = btn.closest('.dialog-node');
    const index = parseInt(node.dataset.nodeId);
    dialogData[currentDialogType].splice(index, 1);
    renderDialogNodes();
}

function moveNodeUp(btn) {
    // Save current data first
    dialogData[currentDialogType] = collectDialogData();

    const node = btn.closest('.dialog-node');
    const index = parseInt(node.dataset.nodeId);
    if (index > 0) {
        const temp = dialogData[currentDialogType][index];
        dialogData[currentDialogType][index] = dialogData[currentDialogType][index - 1];
        dialogData[currentDialogType][index - 1] = temp;
        renderDialogNodes();
    }
}

function moveNodeDown(btn) {
    // Save current data first
    dialogData[currentDialogType] = collectDialogData();

    const node = btn.closest('.dialog-node');
    const index = parseInt(node.dataset.nodeId);
    if (index < dialogData[currentDialogType].length - 1) {
        const temp = dialogData[currentDialogType][index];
        dialogData[currentDialogType][index] = dialogData[currentDialogType][index + 1];
        dialogData[currentDialogType][index + 1] = temp;
        renderDialogNodes();
    }
}

function toggleChoices(checkbox) {
    const node = checkbox.closest('.dialog-node');
    const choicesSection = node.querySelector('.node-choices-section');
    if (checkbox.checked) {
        choicesSection.classList.remove('hidden');
        // Add default choice if none
        if (node.querySelector('.node-choices').children.length === 0) {
            addChoice(node.querySelector('.node-choices-section button'));
        }
    } else {
        choicesSection.classList.add('hidden');
    }
}

function addChoice(btn) {
    const node = btn.closest('.dialog-node');
    const choicesContainer = node.querySelector('.node-choices');
    const template = document.getElementById('choiceTemplate');
    const clone = template.content.cloneNode(true);
    choicesContainer.appendChild(clone);
}

function removeChoice(btn) {
    btn.closest('.choice-item').remove();
}

function updateNodePreview(select) {
    const node = select.closest('.dialog-node');
    const customInput = node.querySelector('.node-custom-speaker');
    if (select.value === 'Custom') {
        customInput.classList.remove('hidden');
    } else {
        customInput.classList.add('hidden');
    }
}

function collectDialogData() {
    const nodes = document.querySelectorAll('#dialogNodes .dialog-node');
    const data = [];

    nodes.forEach(node => {
        const speakerSelect = node.querySelector('.node-speaker');
        const customSpeaker = node.querySelector('.node-custom-speaker');
        const speaker = speakerSelect.value === 'Custom' ? customSpeaker.value : speakerSelect.value;

        const nodeData = {
            speaker: speaker,
            text: node.querySelector('.node-text').value,
            emoji: node.querySelector('.node-emoji').value
        };

        // Add event if set
        const event = node.querySelector('.node-event').value;
        if (event) {
            nodeData.event = event;
        }

        // Add choices if enabled
        if (node.querySelector('.node-has-choices').checked) {
            const choices = [];
            node.querySelectorAll('.choice-item').forEach(choiceEl => {
                const text = choiceEl.querySelector('.choice-text').value;
                const next = choiceEl.querySelector('.choice-next').value;
                if (text) {
                    choices.push({ text, next: next || undefined });
                }
            });
            if (choices.length > 0) {
                nodeData.choices = choices;
            }
        }

        if (nodeData.text || nodeData.choices) {
            data.push(nodeData);
        }
    });

    return data;
}

function saveDialogBuilder() {
    const data = collectDialogData();
    dialogData[currentDialogType] = data;

    // Update hidden input
    const input = document.querySelector(`[name="dialogue_${currentDialogType}"]`);
    input.value = data.length > 0 ? JSON.stringify(data) : '';

    // Update preview
    updateDialogPreview(currentDialogType);

    closeDialogBuilder();
}

function updateDialogPreview(type) {
    const previewEl = document.getElementById(`dialog${type === 'before' ? 'Before' : 'After'}Preview`);
    const data = dialogData[type];

    if (!data || data.length === 0) {
        previewEl.innerHTML = '<span class="text-gray-400">No dialogue configured</span>';
        return;
    }

    let html = '<div class="space-y-2">';
    data.forEach((node, i) => {
        const hasEvent = node.event ? `<span class="text-purple-600 text-xs">[${node.event}]</span>` : '';
        const hasChoices = node.choices ? `<span class="text-blue-600 text-xs">[${node.choices.length} choices]</span>` : '';
        html += `
            <div class="flex items-start gap-2">
                <span class="text-lg">${node.emoji || 'üí¨'}</span>
                <div>
                    <span class="font-medium text-gray-700">${node.speaker}:</span>
                    <span class="text-gray-600">${node.text?.substring(0, 50) || '...'}${node.text?.length > 50 ? '...' : ''}</span>
                    ${hasEvent} ${hasChoices}
                </div>
            </div>
        `;
    });
    html += '</div>';
    previewEl.innerHTML = html;
}

// Initialize previews when editing level
const originalEditLevel = editLevel;
editLevel = function(level) {
    originalEditLevel(level);

    // Load dialogue data
    if (level.dialogue_before) {
        dialogData.before = level.dialogue_before;
        document.querySelector('[name="dialogue_before"]').value = JSON.stringify(level.dialogue_before);
        updateDialogPreview('before');
    } else {
        dialogData.before = [];
        document.querySelector('[name="dialogue_before"]').value = '';
        updateDialogPreview('before');
    }

    if (level.dialogue_after) {
        dialogData.after = level.dialogue_after;
        document.querySelector('[name="dialogue_after"]').value = JSON.stringify(level.dialogue_after);
        updateDialogPreview('after');
    } else {
        dialogData.after = [];
        document.querySelector('[name="dialogue_after"]').value = '';
        updateDialogPreview('after');
    }
};

// Reset on add new level
const originalShowAddLevelModal = showAddLevelModal;
showAddLevelModal = function() {
    originalShowAddLevelModal();
    dialogData = { before: [], after: [] };
    document.querySelector('[name="dialogue_before"]').value = '';
    document.querySelector('[name="dialogue_after"]').value = '';
    updateDialogPreview('before');
    updateDialogPreview('after');
};

// Close dialog builder on backdrop click
document.getElementById('dialogBuilderModal').addEventListener('click', function(e) {
    if (e.target === this) closeDialogBuilder();
});

// ============ AI Dialogue Generation ============
async function generateDialogueWithAI() {
    const btn = document.getElementById('aiGenerateBtn');
    const originalText = btn.innerHTML;

    // Show loading state
    btn.disabled = true;
    btn.innerHTML = `
        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...
    `;

    // Get context
    const chapterName = '{{ chapter.name }}';
    const chapterGenre = '{{ chapter.genre }}';
    const chapterDescription = '{{ chapter.description or "" }}';
    const dialogType = currentDialogType;

    // Get monster from level form if available
    const monsterSelect = document.querySelector('[name="monster_id"]');
    const monsterOption = monsterSelect?.selectedOptions[0];
    const monsterName = monsterOption?.textContent || '–ú–æ–Ω—Å—Ç—Ä';

    // Get existing dialogue for context
    const existingLines = collectDialogData();

    const prompt = dialogType === 'before'
        ? `–ù–∞–ø–∏—à–∏ –¥–∏–∞–ª–æ–≥ –ø–µ—Ä–µ–¥ –±–∏—Ç–≤–æ–π —Å –º–æ–Ω—Å—Ç—Ä–æ–º. –ú–æ–Ω—Å—Ç—Ä —É–≥—Ä–æ–∂–∞–µ—Ç –≥–µ—Ä–æ—é, –≥–µ—Ä–æ–π –æ—Ç–≤–µ—á–∞–µ—Ç.`
        : `–ù–∞–ø–∏—à–∏ –¥–∏–∞–ª–æ–≥ –ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã –Ω–∞–¥ –º–æ–Ω—Å—Ç—Ä–æ–º. –ú–æ–Ω—Å—Ç—Ä –ø–æ–±–µ–∂–¥—ë–Ω, –≥–µ—Ä–æ–π —Ç–æ—Ä–∂–µ—Å—Ç–≤—É–µ—Ç.`;

    try {
        const response = await fetch('/campaign/generate-dialogue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chapter_name: chapterName,
                chapter_genre: chapterGenre,
                chapter_description: chapterDescription,
                monster_name: monsterName,
                dialog_type: dialogType,
                existing_lines: existingLines,
                prompt: prompt
            })
        });

        const result = await response.json();

        if (result.success && result.dialogue) {
            // Save current data first
            dialogData[currentDialogType] = collectDialogData();
            // Append AI generated lines
            dialogData[currentDialogType] = dialogData[currentDialogType].concat(result.dialogue);
            renderDialogNodes();
        } else {
            alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// ============ Reward Functions ============
function showAddRewardModal() {
    document.getElementById('rewardForm').reset();
    document.getElementById('sparksFields').classList.remove('hidden');
    document.getElementById('xpFields').classList.add('hidden');
    document.getElementById('cardFields').classList.add('hidden');
    document.getElementById('rewardModal').classList.remove('hidden');
}

function hideRewardModal() {
    document.getElementById('rewardModal').classList.add('hidden');
}

function updateRewardFields(select) {
    const type = select.value;
    document.getElementById('sparksFields').classList.toggle('hidden', type !== 'sparks');
    document.getElementById('xpFields').classList.toggle('hidden', type !== 'xp');
    document.getElementById('cardFields').classList.toggle('hidden', type !== 'card');

    // Update default emoji
    const emojiInput = document.querySelector('[name="emoji"]');
    if (type === 'sparks') emojiInput.value = '‚ú®';
    else if (type === 'xp') emojiInput.value = '‚≠ê';
    else if (type === 'card') emojiInput.value = 'üé¥';
}

async function saveReward() {
    const form = document.getElementById('rewardForm');
    const formData = new FormData(form);

    const rewardType = formData.get('reward_type');
    let rewardData = {};

    if (rewardType === 'sparks') {
        rewardData = { amount: parseInt(formData.get('sparks_amount')) || 100 };
    } else if (rewardType === 'xp') {
        rewardData = { amount: parseInt(formData.get('xp_amount')) || 500 };
    } else if (rewardType === 'card') {
        rewardData = { rarity: formData.get('card_rarity') || 'rare' };
    }

    const data = {
        reward_type: rewardType,
        reward_data: rewardData,
        name: formData.get('name') || `${rewardData.amount || ''} ${rewardType}`,
        description: formData.get('description') || '',
        emoji: formData.get('emoji') || '‚ú®'
    };

    try {
        const response = await fetch(`/campaign/chapters/${chapterId}/rewards/new`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function deleteReward(rewardId) {
    if (!confirm('Are you sure you want to delete this reward?')) return;

    try {
        const response = await fetch(`/campaign/rewards/${rewardId}/delete`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            document.getElementById('reward-' + rewardId).remove();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Close reward modal on backdrop click
document.getElementById('rewardModal').addEventListener('click', function(e) {
    if (e.target === this) hideRewardModal();
});

// AI Generation Functions
const chapterData = {
    name: {{ chapter.name | tojson }},
    genre: {{ chapter.genre | tojson }},
    description: {{ chapter.description | tojson if chapter.description else '""' }}
};

async function generateChapterImage() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥...';
    btn.disabled = true;

    try {
        const name = document.querySelector('[name="name"]').value || chapterData.name;
        const description = document.querySelector('[name="description"]').value || chapterData.description;
        const genre = document.querySelector('[name="genre"]').value || chapterData.genre;

        const response = await fetch('/campaign/generate-chapter-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, genre })
        });
        const result = await response.json();

        if (result.success) {
            document.querySelector('[name="image_url"]').value = result.image_url;
            alert('Image generated! Save the chapter to apply.');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function generateLevel() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Generating...';
    btn.disabled = true;

    const statusDiv = document.getElementById('levelGenerationStatus');
    statusDiv.textContent = 'Generating...';
    statusDiv.classList.remove('hidden');

    try {
        const form = document.getElementById('levelForm');
        const isBoss = form.querySelector('[name="is_boss"]').checked;
        const levelNumber = document.querySelectorAll('#level-container > div').length + 1;
        const totalLevels = document.querySelectorAll('#level-container > div').length + 5;

        const response = await fetch('/campaign/generate-level', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chapter_name: chapterData.name,
                chapter_genre: chapterData.genre,
                chapter_description: chapterData.description,
                is_boss: isBoss,
                level_number: levelNumber,
                total_levels: totalLevels
            })
        });
        const result = await response.json();

        if (result.success) {
            form.querySelector('[name="title"]').value = result.level_name || '';
            form.querySelector('[name="monster_id"]').value = result.monster_id || '';
            statusDiv.textContent = `‚úÖ ${result.monster_emoji} ${result.monster_name}: "${result.level_name}"`;
        } else {
            statusDiv.textContent = '‚ùå ' + result.error;
        }
    } catch (e) {
        statusDiv.textContent = '‚ùå ' + e.message;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
</script>
{% endblock %}
