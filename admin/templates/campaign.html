{% extends "base.html" %}

{% block title %}Campaign - MoodSprint Admin{% endblock %}
{% block header %}Campaign Chapters{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-purple-600">{{ chapters|length }}</div>
            <div class="text-gray-500">Total Chapters</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-green-600">
                {{ chapters|selectattr('is_active')|list|length }}
            </div>
            <div class="text-gray-500">Active Chapters</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-blue-600">
                {{ chapters|sum(attribute='levels_count') }}
            </div>
            <div class="text-gray-500">Total Levels</div>
        </div>
    </div>

    <!-- Add Chapter Button -->
    <div class="flex justify-end">
        <button onclick="showAddChapterModal()"
                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
            + Add Chapter
        </button>
    </div>

    <!-- Chapters by Genre -->
    {% for genre, genre_chapters in chapters_by_genre.items() %}
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-4 py-3 bg-gray-50 border-b flex items-center justify-between">
            <h3 class="font-semibold text-gray-800 capitalize flex items-center gap-2">
                {% if genre == 'fantasy' %}‚öîÔ∏è
                {% elif genre == 'magic' %}‚ú®
                {% elif genre == 'scifi' %}üöÄ
                {% elif genre == 'cyberpunk' %}üåÜ
                {% elif genre == 'anime' %}üéå
                {% else %}üìñ{% endif %}
                {{ genre }} ({{ genre_chapters|length }} chapters)
            </h3>
            <button onclick="renumberChapters('{{ genre }}')"
                    class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                    title="Fix chapter numbering to 1, 2, 3...">
                üî¢ Renumber
            </button>
        </div>
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ch #</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Chapter</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Levels</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Reward</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for chapter in genre_chapters %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">{{ chapter.number }}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            {% if chapter.image_url %}
                            <img src="{{ chapter.image_url }}" alt="" class="w-10 h-10 rounded-lg object-cover mr-2">
                            {% else %}
                            <span class="text-2xl mr-2">{{ chapter.emoji }}</span>
                            {% endif %}
                            <div>
                                <div class="font-medium text-gray-900">{{ chapter.name }}</div>
                                <div class="text-xs text-gray-500 max-w-xs truncate">{{ chapter.description or '' }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">{{ chapter.levels_count }}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs
                            {% if chapter.guaranteed_card_rarity == 'legendary' %}bg-amber-100 text-amber-800
                            {% elif chapter.guaranteed_card_rarity == 'epic' %}bg-purple-100 text-purple-800
                            {% elif chapter.guaranteed_card_rarity == 'rare' %}bg-blue-100 text-blue-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ chapter.guaranteed_card_rarity }}
                        </span>
                        + {{ chapter.xp_reward }} XP
                    </td>
                    <td class="px-4 py-3">
                        {% if chapter.is_active %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Active</span>
                        {% else %}
                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm space-x-2">
                        <a href="{{ url_for('chapter_detail', chapter_id=chapter.id) }}"
                           class="text-purple-600 hover:text-purple-800">Edit</a>
                        <button onclick="deleteChapter({{ chapter.id }}, '{{ chapter.name }}')"
                                class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}

    {% if not chapters_by_genre %}
    <div class="bg-white rounded-lg shadow p-12 text-center text-gray-500">
        No chapters yet. Create your first chapter!
    </div>
    {% endif %}
</div>

<!-- Add Chapter Modal -->
<div id="addChapterModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
        <div class="p-4 border-b">
            <h3 class="text-lg font-semibold">Add New Chapter</h3>
        </div>
        <form id="addChapterForm" class="p-4 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name (RU) *</label>
                    <input type="text" name="name" required
                           class="w-full border rounded-lg px-3 py-2"
                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name (EN)</label>
                    <input type="text" name="name_en"
                           class="w-full border rounded-lg px-3 py-2"
                           placeholder="Chapter name">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Genre *</label>
                    <select name="genre" required class="w-full border rounded-lg px-3 py-2">
                        <option value="fantasy">Fantasy</option>
                        <option value="magic">Magic</option>
                        <option value="scifi">Sci-Fi</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="anime">Anime</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                    <input type="text" name="emoji" value="üìñ"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
            </div>
            <div>
                <button type="button" onclick="generateChapterContent()"
                        class="w-full px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 flex items-center justify-center gap-2">
                    ü§ñ Generate name, description, intro & outro with AI
                </button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description (RU)</label>
                    <textarea name="description" rows="2"
                              class="w-full border rounded-lg px-3 py-2"
                              placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥–ª–∞–≤—ã"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description (EN)</label>
                    <textarea name="description_en" rows="2"
                              class="w-full border rounded-lg px-3 py-2"
                              placeholder="Chapter description"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">XP Reward</label>
                    <input type="number" name="xp_reward" value="500"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Card Rarity</label>
                    <select name="guaranteed_card_rarity" class="w-full border rounded-lg px-3 py-2">
                        <option value="rare">Rare</option>
                        <option value="epic">Epic</option>
                        <option value="legendary">Legendary</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Story Intro (RU)</label>
                    <textarea name="story_intro" rows="3"
                              class="w-full border rounded-lg px-3 py-2"
                              placeholder="–¢–µ–∫—Å—Ç –≤ –Ω–∞—á–∞–ª–µ –≥–ª–∞–≤—ã"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Story Intro (EN)</label>
                    <textarea name="story_intro_en" rows="3"
                              class="w-full border rounded-lg px-3 py-2"
                              placeholder="Text shown at the beginning"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Story Outro (RU)</label>
                    <textarea name="story_outro" rows="3"
                              class="w-full border rounded-lg px-3 py-2"
                              placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≥–ª–∞–≤—ã"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Story Outro (EN)</label>
                    <textarea name="story_outro_en" rows="3"
                              class="w-full border rounded-lg px-3 py-2"
                              placeholder="Text shown after completing"></textarea>
                </div>
            </div>
        </form>
        <div class="p-4 border-t flex justify-end gap-2">
            <button onclick="hideAddChapterModal()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onclick="createChapter()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Create</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function showAddChapterModal() {
    document.getElementById('addChapterModal').classList.remove('hidden');
}

function hideAddChapterModal() {
    document.getElementById('addChapterModal').classList.add('hidden');
    document.getElementById('addChapterForm').reset();
}

async function createChapter() {
    const form = document.getElementById('addChapterForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.xp_reward = parseInt(data.xp_reward) || 500;

    try {
        const response = await fetch('/campaign/chapters/new', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Close modal on backdrop click
document.getElementById('addChapterModal').addEventListener('click', function(e) {
    if (e.target === this) hideAddChapterModal();
});

async function deleteChapter(chapterId, chapterName) {
    if (!confirm(`Delete chapter "${chapterName}"?\n\nThis will also delete all levels in this chapter.`)) {
        return;
    }

    try {
        const response = await fetch(`/campaign/chapters/${chapterId}/delete`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function renumberChapters(genre) {
    if (!confirm(`Renumber all chapters in "${genre}" to be sequential (1, 2, 3...)?`)) {
        return;
    }

    try {
        const response = await fetch(`/campaign/chapters/renumber/${genre}`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function generateChapterContent() {
    const form = document.getElementById('addChapterForm');
    const genre = form.querySelector('[name="genre"]').value;
    const btn = event.target;
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '‚è≥ Generating...';

    try {
        const response = await fetch('/campaign/generate-chapter-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ genre })
        });
        const result = await response.json();

        if (result.success) {
            const data = result.content || result.data || {};
            form.querySelector('[name="name"]').value = data.name || '';
            form.querySelector('[name="description"]').value = data.description || '';
            form.querySelector('[name="story_intro"]').value = data.story_intro || '';
            form.querySelector('[name="story_outro"]').value = data.story_outro || '';
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
</script>
{% endblock %}
