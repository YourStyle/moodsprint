{% extends "base.html" %}
{% block title %}Analytics - MoodSprint Admin{% endblock %}
{% block header %}Advanced Analytics{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<div class="mb-6 border-b border-gray-200">
    <nav class="flex gap-4" id="analyticsTabs">
        <button onclick="showTab('funnel')"
                class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-purple-600 text-purple-700"
                data-tab="funnel">
            Activation Funnel
        </button>
        <button onclick="showTab('adoption')"
                class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"
                data-tab="adoption">
            Feature Adoption
        </button>
        <button onclick="showTab('revenue')"
                class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"
                data-tab="revenue">
            Revenue
        </button>
    </nav>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- TAB 1: ACTIVATION FUNNEL                       -->
<!-- ═══════════════════════════════════════════════ -->
<div id="tab-funnel" class="tab-content">
    <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">User Activation Funnel</h3>
        <p class="text-sm text-gray-500 mb-6">Conversion from registration to key milestones (all-time)</p>

        <div class="space-y-3">
            {% for step in funnel %}
            {% set pct = (step.count / total_users * 100) if total_users > 0 else 0 %}
            {% set prev_count = funnel[loop.index0 - 1].count if loop.index0 > 0 else total_users %}
            {% set step_pct = (step.count / prev_count * 100) if prev_count > 0 else 0 %}
            {% set drop = prev_count - step.count if loop.index0 > 0 else 0 %}
            <div class="relative">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-7 h-7 rounded-full
                            {% if pct >= 50 %}bg-green-100 text-green-700
                            {% elif pct >= 25 %}bg-yellow-100 text-yellow-700
                            {% elif pct >= 10 %}bg-orange-100 text-orange-700
                            {% else %}bg-red-100 text-red-700{% endif %}
                            text-xs font-bold">
                            {{ loop.index }}
                        </span>
                        <span class="text-sm font-medium text-gray-800">{{ step.step }}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-gray-900">{{ step.count }}</span>
                        <span class="text-xs font-medium px-2 py-0.5 rounded
                            {% if pct >= 50 %}bg-green-100 text-green-700
                            {% elif pct >= 25 %}bg-yellow-100 text-yellow-700
                            {% elif pct >= 10 %}bg-orange-100 text-orange-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ pct|round(1) }}%
                        </span>
                        {% if loop.index0 > 0 %}
                        <span class="text-xs text-gray-400 w-24 text-right"
                              title="Step conversion: {{ step_pct|round(1) }}% — lost {{ drop }}">
                            &darr; {{ step_pct|round(1) }}% step
                        </span>
                        {% else %}
                        <span class="w-24"></span>
                        {% endif %}
                    </div>
                </div>
                <!-- Progress bar -->
                <div class="w-full bg-gray-100 rounded-full h-5 overflow-hidden">
                    <div class="h-5 rounded-full transition-all duration-500
                        {% if pct >= 50 %}bg-gradient-to-r from-green-400 to-green-500
                        {% elif pct >= 25 %}bg-gradient-to-r from-yellow-400 to-yellow-500
                        {% elif pct >= 10 %}bg-gradient-to-r from-orange-400 to-orange-500
                        {% else %}bg-gradient-to-r from-red-400 to-red-500{% endif %}"
                         style="width: {{ [pct, 2]|max }}%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Funnel Chart -->
    <div class="bg-white rounded-xl p-6 shadow-sm">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Funnel Visualization</h3>
        <canvas id="funnelChart" height="300"></canvas>
    </div>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- TAB 2: FEATURE ADOPTION                        -->
<!-- ═══════════════════════════════════════════════ -->
<div id="tab-adoption" class="tab-content hidden">
    <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Feature Adoption</h3>
        <p class="text-sm text-gray-500 mb-6">Percentage of total users ({{ total_users }}) who have used each feature at least once</p>

        <div class="space-y-3">
            {% for feat in adoption %}
            {% set pct = (feat.users / total_users * 100) if total_users > 0 else 0 %}
            <div>
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">{{ feat.feature }}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-500">{{ feat.users }} users</span>
                        <span class="text-sm font-bold
                            {% if pct >= 50 %}text-green-600
                            {% elif pct >= 25 %}text-yellow-600
                            {% elif pct >= 10 %}text-orange-600
                            {% else %}text-red-600{% endif %}">
                            {{ pct|round(1) }}%
                        </span>
                    </div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-4">
                    <div class="h-4 rounded-full
                        {% if pct >= 50 %}bg-green-400
                        {% elif pct >= 25 %}bg-yellow-400
                        {% elif pct >= 10 %}bg-orange-400
                        {% else %}bg-red-400{% endif %}"
                         style="width: {{ [pct, 1]|max }}%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Adoption Chart -->
    <div class="bg-white rounded-xl p-6 shadow-sm">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Adoption Overview</h3>
        <canvas id="adoptionChart" height="400"></canvas>
    </div>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- TAB 3: REVENUE                                 -->
<!-- ═══════════════════════════════════════════════ -->
<div id="tab-revenue" class="tab-content hidden">
    <!-- Revenue KPIs -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-green-500">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Sparks Sold (Stars)</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ total_sparks_sold|int }}</p>
            <p class="text-xs text-gray-400">via Telegram Stars</p>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-blue-500">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Sparks Sold (TON)</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ total_sparks_ton|int }}</p>
            <p class="text-xs text-gray-400">via TON deposits</p>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-purple-500">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Paying Users</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ paying_users_count }}</p>
            <p class="text-xs text-gray-400">{{ conversion_rate }}% conversion</p>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-amber-500">
            <p class="text-xs text-gray-500 uppercase tracking-wide">ARPU</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">
                {{ (total_sparks_sold + total_sparks_ton) // [paying_users_count, 1]|max }} sp
            </p>
            <p class="text-xs text-gray-400">sparks per paying user</p>
        </div>
    </div>

    <!-- Marketplace Stats -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-xl p-5 shadow-sm">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Active Listings</p>
            <p class="text-xl font-bold text-gray-900 mt-1">{{ marketplace_stats.active }}</p>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Total Sales</p>
            <p class="text-xl font-bold text-gray-900 mt-1">{{ marketplace_stats.sold }}</p>
            <p class="text-xs text-gray-400">{{ marketplace_stats.volume_sparks|int }} sparks volume</p>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Market Participants</p>
            <p class="text-xl font-bold text-gray-900 mt-1">
                {{ marketplace_stats.sellers }} sellers / {{ marketplace_stats.buyers }} buyers
            </p>
        </div>
    </div>

    <!-- Revenue Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Daily Purchases (30 days)</h3>
            <canvas id="revenueDailyChart" height="200"></canvas>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Marketplace Volume (30 days)</h3>
            <canvas id="marketDailyChart" height="200"></canvas>
        </div>
    </div>

    <!-- Pack Distribution & Economy -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Pack Distribution -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pack Distribution</h3>
            {% if pack_distribution %}
            <div class="space-y-2">
                {% for pack in pack_distribution %}
                {% set total_purchases = pack_distribution|map(attribute='purchases')|sum %}
                {% set pct = (pack.purchases / total_purchases * 100) if total_purchases > 0 else 0 %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <span class="text-sm font-medium text-gray-800">{{ pack.name }}</span>
                        <span class="text-xs text-gray-500 ml-2">{{ pack.sparks|int }} sparks total</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-gray-900">{{ pack.purchases }}x</span>
                        <span class="text-xs text-gray-400">({{ pct|round(1) }}%)</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-gray-400">No purchases yet</p>
            {% endif %}
        </div>

        <!-- Sparks Economy -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Sparks Economy Flow</h3>
            {% if sparks_economy %}
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="border-b-2">
                            <th class="text-left py-2 px-3 text-gray-500">Type</th>
                            <th class="text-right py-2 px-3 text-gray-500">Txns</th>
                            <th class="text-right py-2 px-3 text-gray-500">Inflow</th>
                            <th class="text-right py-2 px-3 text-gray-500">Outflow</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in sparks_economy %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-2 px-3">
                                <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">
                                    {{ e.type }}
                                </span>
                            </td>
                            <td class="py-2 px-3 text-right font-mono">{{ e.transactions }}</td>
                            <td class="py-2 px-3 text-right font-mono text-green-600">
                                {% if e.inflow > 0 %}+{{ e.inflow|int }}{% else %}-{% endif %}
                            </td>
                            <td class="py-2 px-3 text-right font-mono text-red-600">
                                {% if e.outflow > 0 %}-{{ e.outflow|int }}{% else %}-{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-sm text-gray-400">No transactions yet</p>
            {% endif %}
        </div>
    </div>

    <!-- Stars Transactions by Type -->
    {% if stars_by_type %}
    <div class="bg-white rounded-xl p-6 shadow-sm">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Telegram Stars Transactions</h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            {% for st in stars_by_type %}
            <div class="p-4 bg-gray-50 rounded-lg text-center">
                <p class="text-xs text-gray-500 uppercase">{{ st.type }}</p>
                <p class="text-lg font-bold text-gray-900 mt-1">{{ st.count }}</p>
                <p class="text-xs text-gray-400">{{ st.total|int }} stars</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    const funnelData = {{ funnel | tojson }};
    const adoptionData = {{ adoption | tojson }};
    const revenueDaily = {{ revenue_daily | tojson }};
    const totalUsers = {{ total_users }};

    // ── Tab switching ──
    function showTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('border-purple-600', 'text-purple-700');
            btn.classList.add('border-transparent', 'text-gray-500');
        });
        document.getElementById('tab-' + tab).classList.remove('hidden');
        const activeBtn = document.querySelector(`[data-tab="${tab}"]`);
        activeBtn.classList.remove('border-transparent', 'text-gray-500');
        activeBtn.classList.add('border-purple-600', 'text-purple-700');
    }

    // Chart defaults
    const defaultOpts = {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: 'rgba(17,24,39,0.9)',
                titleFont: { size: 13 },
                bodyFont: { size: 12 },
                padding: 10,
                cornerRadius: 8
            }
        },
        scales: {
            x: {
                grid: { display: false },
                ticks: { font: { size: 10 }, maxRotation: 45 }
            },
            y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.05)' },
                ticks: { precision: 0 }
            }
        }
    };

    // ── Funnel Chart (horizontal bar) ──
    new Chart(document.getElementById('funnelChart'), {
        type: 'bar',
        data: {
            labels: funnelData.map(d => d.step),
            datasets: [{
                label: 'Users',
                data: funnelData.map(d => d.count),
                backgroundColor: funnelData.map((d, i) => {
                    const pct = totalUsers > 0 ? d.count / totalUsers * 100 : 0;
                    if (pct >= 50) return 'rgba(34, 197, 94, 0.7)';
                    if (pct >= 25) return 'rgba(234, 179, 8, 0.7)';
                    if (pct >= 10) return 'rgba(249, 115, 22, 0.7)';
                    return 'rgba(239, 68, 68, 0.7)';
                }),
                borderRadius: 6,
                barThickness: 30
            }]
        },
        options: {
            ...defaultOpts,
            indexAxis: 'y',
            plugins: {
                ...defaultOpts.plugins,
                tooltip: {
                    ...defaultOpts.plugins.tooltip,
                    callbacks: {
                        label: ctx => {
                            const pct = totalUsers > 0 ? (ctx.parsed.x / totalUsers * 100).toFixed(1) : 0;
                            return `${ctx.parsed.x} users (${pct}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { precision: 0 }
                },
                y: {
                    grid: { display: false },
                    ticks: { font: { size: 12, weight: '500' } }
                }
            }
        }
    });

    // ── Feature Adoption Chart (horizontal bar) ──
    new Chart(document.getElementById('adoptionChart'), {
        type: 'bar',
        data: {
            labels: adoptionData.map(d => d.feature),
            datasets: [{
                label: 'Adoption %',
                data: adoptionData.map(d => totalUsers > 0 ? (d.users / totalUsers * 100).toFixed(1) : 0),
                backgroundColor: adoptionData.map(d => {
                    const pct = totalUsers > 0 ? d.users / totalUsers * 100 : 0;
                    if (pct >= 50) return 'rgba(34, 197, 94, 0.7)';
                    if (pct >= 25) return 'rgba(234, 179, 8, 0.7)';
                    if (pct >= 10) return 'rgba(249, 115, 22, 0.7)';
                    return 'rgba(239, 68, 68, 0.7)';
                }),
                borderRadius: 4,
                barThickness: 22
            }]
        },
        options: {
            ...defaultOpts,
            indexAxis: 'y',
            plugins: {
                ...defaultOpts.plugins,
                tooltip: {
                    ...defaultOpts.plugins.tooltip,
                    callbacks: {
                        label: ctx => {
                            const feat = adoptionData[ctx.dataIndex];
                            return `${feat.users} users (${ctx.parsed.x}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { callback: v => v + '%' }
                },
                y: {
                    grid: { display: false },
                    ticks: { font: { size: 11 } }
                }
            }
        }
    });

    // ── Revenue Daily Chart ──
    new Chart(document.getElementById('revenueDailyChart'), {
        type: 'bar',
        data: {
            labels: revenueDaily.map(d => d.date.slice(5)),
            datasets: [{
                label: 'Sparks Purchased',
                data: revenueDaily.map(d => d.sparks_purchased),
                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                borderRadius: 4,
                yAxisID: 'y'
            }, {
                label: 'Purchases',
                data: revenueDaily.map(d => d.purchase_count),
                type: 'line',
                borderColor: 'rgb(168, 85, 247)',
                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                tension: 0.3,
                pointRadius: 3,
                yAxisID: 'y1'
            }]
        },
        options: {
            ...defaultOpts,
            plugins: {
                ...defaultOpts.plugins,
                legend: { display: true, position: 'top' }
            },
            scales: {
                x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45 } },
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    title: { display: true, text: 'Sparks' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    grid: { display: false },
                    title: { display: true, text: 'Purchases' }
                }
            }
        }
    });

    // ── Market Volume Chart ──
    new Chart(document.getElementById('marketDailyChart'), {
        type: 'bar',
        data: {
            labels: revenueDaily.map(d => d.date.slice(5)),
            datasets: [{
                label: 'Volume (Sparks)',
                data: revenueDaily.map(d => d.market_volume),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderRadius: 4,
                yAxisID: 'y'
            }, {
                label: 'Sales',
                data: revenueDaily.map(d => d.market_sales),
                type: 'line',
                borderColor: 'rgb(249, 115, 22)',
                tension: 0.3,
                pointRadius: 3,
                yAxisID: 'y1'
            }]
        },
        options: {
            ...defaultOpts,
            plugins: {
                ...defaultOpts.plugins,
                legend: { display: true, position: 'top' }
            },
            scales: {
                x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45 } },
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    title: { display: true, text: 'Sparks' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    grid: { display: false },
                    title: { display: true, text: 'Sales' }
                }
            }
        }
    });
</script>
{% endblock %}
