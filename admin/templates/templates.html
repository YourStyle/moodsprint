{% extends "base.html" %}
{% block title %}Templates - MoodSprint Admin{% endblock %}
{% block header %}Decomposition Templates{% endblock %}

{% block content %}
<!-- Stats -->
<div class="grid grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-purple-500">
        <p class="text-xs text-gray-500 uppercase">Total Templates</p>
        <p class="text-2xl font-bold text-gray-900 mt-1">{{ templates|length }}</p>
    </div>
    <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-green-500">
        <p class="text-xs text-gray-500 uppercase">Active</p>
        <p class="text-2xl font-bold text-gray-900 mt-1">{{ templates|selectattr('is_active')|list|length }}</p>
    </div>
    <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-blue-500">
        <p class="text-xs text-gray-500 uppercase">Total Uses</p>
        <p class="text-2xl font-bold text-gray-900 mt-1">{{ templates|map(attribute='usage_count')|sum }}</p>
    </div>
</div>

<!-- Create Template -->
<div class="bg-white rounded-xl shadow-sm mb-6">
    <div class="px-6 py-4 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Create Template</h3>
        <button onclick="document.getElementById('createForm').classList.toggle('hidden')"
                class="text-sm text-purple-600 hover:text-purple-800">
            Show/Hide Form
        </button>
    </div>
    <form id="createForm" action="{{ url_for('create_template') }}" method="POST" class="p-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Title Pattern
                    <span class="text-xs text-gray-400">(use % as wildcard, e.g. "%уборк%")</span>
                </label>
                <input type="text" name="title_pattern" required
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                       placeholder="%уборк%">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select name="category" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="">Any</option>
                    <option value="creative">Creative</option>
                    <option value="analytical">Analytical</option>
                    <option value="communication">Communication</option>
                    <option value="physical">Physical</option>
                    <option value="learning">Learning</option>
                    <option value="planning">Planning</option>
                    <option value="coding">Coding</option>
                    <option value="writing">Writing</option>
                    <option value="household">Household</option>
                    <option value="shopping">Shopping</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Strategy</label>
                <select name="strategy" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="standard">Standard</option>
                    <option value="micro">Micro</option>
                    <option value="gentle">Gentle</option>
                    <option value="careful">Careful</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Mood Min</label>
                <input type="number" name="mood_min" min="1" max="5"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Any">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Mood Max</label>
                <input type="number" name="mood_max" min="1" max="5"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Any">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Energy Min</label>
                <input type="number" name="energy_min" min="1" max="5"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Any">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Energy Max</label>
                <input type="number" name="energy_max" min="1" max="5"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Any">
            </div>
        </div>

        <div class="mb-4">
            <label class="flex items-center gap-2">
                <input type="checkbox" name="no_new_steps" id="noNewSteps"
                       onchange="document.getElementById('stepsSection').classList.toggle('hidden', this.checked)"
                       class="rounded border-gray-300">
                <span class="text-sm text-gray-700">No decomposition needed (no_new_steps)</span>
            </label>
        </div>

        <div id="stepsSection">
            <label class="block text-sm font-medium text-gray-700 mb-2">Steps</label>
            <div id="stepsContainer" class="space-y-2 mb-3">
                <div class="flex gap-2">
                    <input type="text" name="step_title" placeholder="Step title"
                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <input type="number" name="step_minutes" value="15" min="1" max="180"
                           class="w-20 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="min">
                </div>
            </div>
            <button type="button" onclick="addStep()"
                    class="text-sm text-blue-600 hover:text-blue-800">+ Add Step</button>
        </div>

        <div class="mt-4">
            <button type="submit"
                    class="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700">
                Create Template
            </button>
        </div>
    </form>
</div>

<!-- Popular Tasks Suggestions -->
{% if top_tasks %}
<div class="bg-white rounded-xl shadow-sm mb-6">
    <div class="px-6 py-4 border-b">
        <h3 class="text-lg font-semibold text-gray-900">Frequent Tasks (template candidates)</h3>
        <p class="text-xs text-gray-500 mt-1">Tasks repeated 3+ times that could benefit from a template</p>
    </div>
    <div class="p-6">
        <div class="flex flex-wrap gap-2">
            {% for task in top_tasks %}
            <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 rounded-full text-sm">
                <span class="font-medium text-gray-800">{{ task.title }}</span>
                <span class="text-xs text-gray-400">({{ task.count }}x)</span>
            </span>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Templates List -->
<div class="bg-white rounded-xl shadow-sm">
    <div class="px-6 py-4 border-b">
        <h3 class="text-lg font-semibold text-gray-900">All Templates ({{ templates|length }})</h3>
    </div>
    {% if templates %}
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="text-left py-3 px-4 text-gray-500">Pattern</th>
                    <th class="text-center py-3 px-4 text-gray-500">Category</th>
                    <th class="text-center py-3 px-4 text-gray-500">Strategy</th>
                    <th class="text-center py-3 px-4 text-gray-500">Mood</th>
                    <th class="text-center py-3 px-4 text-gray-500">Energy</th>
                    <th class="text-center py-3 px-4 text-gray-500">Result</th>
                    <th class="text-center py-3 px-4 text-gray-500">Uses</th>
                    <th class="text-center py-3 px-4 text-gray-500">Status</th>
                    <th class="text-center py-3 px-4 text-gray-500">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t in templates %}
                <tr class="border-b border-gray-100 hover:bg-gray-50 {% if not t.is_active %}opacity-50{% endif %}">
                    <td class="py-3 px-4 font-mono text-gray-800 max-w-xs truncate" title="{{ t.title_pattern }}">
                        {{ t.title_pattern }}
                    </td>
                    <td class="py-3 px-4 text-center">
                        {% if t.category %}
                        <span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">{{ t.category }}</span>
                        {% else %}<span class="text-gray-400">-</span>{% endif %}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="px-2 py-0.5 rounded text-xs
                            {% if t.strategy == 'micro' %}bg-red-100 text-red-700
                            {% elif t.strategy == 'gentle' %}bg-yellow-100 text-yellow-700
                            {% elif t.strategy == 'careful' %}bg-orange-100 text-orange-700
                            {% else %}bg-green-100 text-green-700{% endif %}">
                            {{ t.strategy }}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center text-xs text-gray-500">
                        {{ t.mood_min or '-' }} - {{ t.mood_max or '-' }}
                    </td>
                    <td class="py-3 px-4 text-center text-xs text-gray-500">
                        {{ t.energy_min or '-' }} - {{ t.energy_max or '-' }}
                    </td>
                    <td class="py-3 px-4 text-center">
                        {% if t.no_new_steps %}
                        <span class="text-xs text-gray-400">no_new_steps</span>
                        {% else %}
                        <span class="text-xs text-blue-600">{{ t.subtasks|length }} steps</span>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="font-bold {% if t.usage_count > 10 %}text-green-600{% else %}text-gray-600{% endif %}">
                            {{ t.usage_count }}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        {% if t.is_active %}
                        <span class="px-2 py-0.5 rounded text-xs bg-green-100 text-green-700">Active</span>
                        {% else %}
                        <span class="px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-500">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <form action="{{ url_for('toggle_template', template_id=t.id) }}" method="POST" class="inline">
                                <button type="submit" class="text-blue-500 hover:text-blue-700 text-xs">
                                    {% if t.is_active %}Disable{% else %}Enable{% endif %}
                                </button>
                            </form>
                            <form action="{{ url_for('delete_template', template_id=t.id) }}" method="POST" class="inline"
                                  onsubmit="return confirm('Delete this template?')">
                                <button type="submit" class="text-red-500 hover:text-red-700 text-xs">&times; Del</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="px-6 py-12 text-center text-gray-400">
        <p class="text-lg">No templates yet</p>
        <p class="text-sm mt-1">Create templates for frequently repeated tasks to save AI costs</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function addStep() {
        const container = document.getElementById('stepsContainer');
        const div = document.createElement('div');
        div.className = 'flex gap-2';
        div.innerHTML = `
            <input type="text" name="step_title" placeholder="Step title"
                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
            <input type="number" name="step_minutes" value="15" min="1" max="180"
                   class="w-20 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="min">
            <button type="button" onclick="this.parentElement.remove()"
                    class="text-red-400 hover:text-red-600 text-sm px-2">&times;</button>
        `;
        container.appendChild(div);
    }
</script>
{% endblock %}
