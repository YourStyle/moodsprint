{% extends "base.html" %}

{% block title %}Monster: {{ monster.name }} - MoodSprint Admin{% endblock %}
{% block header %}
<a href="{{ url_for('monsters') }}" class="text-purple-600 hover:text-purple-800">&larr; Back to Monsters</a>
<span class="mx-2 text-gray-400">/</span>
{{ monster.emoji }} {{ monster.name }}
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Monster Details -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-start justify-between mb-6">
            <div class="flex items-center gap-4">
                {% if monster.sprite_url %}
                <img src="https://moodsprint.ru{{ monster.sprite_url }}" alt="{{ monster.name }}" class="w-24 h-24 rounded-xl object-cover">
                {% else %}
                <div class="w-24 h-24 bg-gray-100 rounded-xl flex items-center justify-center text-5xl">
                    {{ monster.emoji }}
                </div>
                {% endif %}
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">{{ monster.name }}</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="px-2 py-1 bg-gray-100 rounded text-sm capitalize">{{ monster.genre }}</span>
                        {% if monster.is_boss %}
                        <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">BOSS</span>
                        {% endif %}
                        <span class="text-gray-500 text-sm">Level {{ monster.base_level }}</span>
                    </div>
                </div>
            </div>
            <button onclick="toggleEditMode()" id="editBtn"
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700">
                Edit Monster
            </button>
        </div>

        <!-- Edit Form -->
        <form id="monsterForm" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" name="name" value="{{ monster.name }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Genre</label>
                    <select name="genre" class="w-full border rounded-lg px-3 py-2">
                        {% for g in ['fantasy', 'magic', 'scifi', 'cyberpunk', 'anime'] %}
                        <option value="{{ g }}" {{ 'selected' if g == monster.genre else '' }}>{{ g|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea name="description" rows="2"
                          class="w-full border rounded-lg px-3 py-2">{{ monster.description or '' }}</textarea>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                    <input type="text" name="emoji" value="{{ monster.emoji }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Base Level</label>
                    <input type="number" name="base_level" value="{{ monster.base_level }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Base HP</label>
                    <input type="number" name="base_hp" value="{{ monster.base_hp }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Base Attack</label>
                    <input type="number" name="base_attack" value="{{ monster.base_attack }}"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Image</label>
                <div class="flex gap-2">
                    <input type="url" name="sprite_url" value="{{ monster.sprite_url or '' }}"
                           class="flex-1 border rounded-lg px-3 py-2" placeholder="URL or upload file">
                    <label class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg cursor-pointer text-gray-700">
                        Upload
                        <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="uploadImage(this)">
                    </label>
                </div>
                <div id="uploadStatus" class="text-sm mt-1"></div>
            </div>
            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" name="is_boss" {{ 'checked' if monster.is_boss else '' }}
                           class="rounded text-red-600">
                    <span class="text-sm text-gray-700">Is Boss</span>
                </label>
            </div>
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button type="button" onclick="toggleEditMode()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Changes</button>
            </div>
        </form>

        <!-- View Mode -->
        <div id="monsterView" class="space-y-4">
            {% if monster.description %}
            <p class="text-gray-600">{{ monster.description }}</p>
            {% endif %}

            <div class="grid grid-cols-3 gap-4 text-sm">
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">Base HP</div>
                    <div class="text-lg font-semibold text-green-600">{{ monster.base_hp }}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">Base Attack</div>
                    <div class="text-lg font-semibold text-red-600">{{ monster.base_attack }}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-gray-500">Base Level</div>
                    <div class="text-lg font-semibold">{{ monster.base_level }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monster Cards -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex items-center justify-between">
            <h3 class="text-lg font-semibold">Monster Cards ({{ cards|length }})</h3>
            <button onclick="showAddCardModal()"
                    class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                + Add Card
            </button>
        </div>

        <div class="divide-y">
            {% for card in cards %}
            <div class="p-4 hover:bg-gray-50 flex items-center gap-4" id="card-{{ card.id }}">
                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-2xl">
                    {{ card.emoji }}
                </div>
                <div class="flex-1">
                    <div class="font-medium">{{ card.name }}</div>
                    <div class="text-sm text-gray-500">
                        ATK: {{ card.attack }} | HP: {{ card.hp }}
                        {% if card.ability %}<span class="text-purple-600">| {{ card.ability }}</span>{% endif %}
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="editCard({{ card|tojson|e }})"
                            class="text-purple-600 hover:text-purple-800 text-sm">Edit</button>
                    <button onclick="deleteCard({{ card.id }})"
                            class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                </div>
            </div>
            {% endfor %}

            {% if not cards %}
            <div class="p-8 text-center text-gray-500">
                No cards yet. Add monster cards!
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Delete Monster -->
    <div class="bg-red-50 rounded-lg shadow p-4 border border-red-200">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="font-medium text-red-800">Delete Monster</h3>
                <p class="text-sm text-red-600">This will also delete all associated cards.</p>
            </div>
            <button onclick="deleteMonster()"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                Delete Monster
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Card Modal -->
<div id="cardModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
        <div class="p-4 border-b">
            <h3 id="cardModalTitle" class="text-lg font-semibold">Add Card</h3>
        </div>
        <form id="cardForm" class="p-4 space-y-4">
            <input type="hidden" name="card_id" value="">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                    <input type="text" name="name" required
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                    <input type="text" name="emoji" value="⚔️"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea name="description" rows="2"
                          class="w-full border rounded-lg px-3 py-2"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Attack</label>
                    <input type="number" name="attack" value="10"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">HP</label>
                    <input type="number" name="hp" value="20"
                           class="w-full border rounded-lg px-3 py-2">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ability</label>
                <input type="text" name="ability"
                       class="w-full border rounded-lg px-3 py-2"
                       placeholder="e.g., heal, poison, shield">
            </div>
        </form>
        <div class="p-4 border-t flex justify-end gap-2">
            <button onclick="hideCardModal()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onclick="saveCard()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const monsterId = {{ monster.id }};

function toggleEditMode() {
    const form = document.getElementById('monsterForm');
    const view = document.getElementById('monsterView');
    const btn = document.getElementById('editBtn');

    if (form.classList.contains('hidden')) {
        form.classList.remove('hidden');
        view.classList.add('hidden');
        btn.textContent = 'Cancel';
    } else {
        form.classList.add('hidden');
        view.classList.remove('hidden');
        btn.textContent = 'Edit Monster';
    }
}

async function uploadImage(input) {
    const file = input.files[0];
    if (!file) return;

    const status = document.getElementById('uploadStatus');
    status.textContent = 'Uploading...';
    status.className = 'text-sm mt-1 text-blue-600';

    const formData = new FormData();
    formData.append('image', file);

    try {
        const response = await fetch(`/monsters/${monsterId}/upload-image`, {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success) {
            status.textContent = 'Uploaded successfully!';
            status.className = 'text-sm mt-1 text-green-600';
            document.querySelector('[name="sprite_url"]').value = result.sprite_url;
            // Reload to show new image
            setTimeout(() => window.location.reload(), 500);
        } else {
            status.textContent = 'Error: ' + result.error;
            status.className = 'text-sm mt-1 text-red-600';
        }
    } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.className = 'text-sm mt-1 text-red-600';
    }
}

document.getElementById('monsterForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    data.is_boss = formData.has('is_boss');
    data.base_level = parseInt(data.base_level) || 1;
    data.base_hp = parseInt(data.base_hp) || 100;
    data.base_attack = parseInt(data.base_attack) || 10;

    try {
        const response = await fetch(`/monsters/${monsterId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
});

async function deleteMonster() {
    if (!confirm('Are you sure you want to delete this monster and all its cards?')) return;

    try {
        const response = await fetch(`/monsters/${monsterId}/delete`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            window.location.href = '/monsters';
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Card Modal Functions
function showAddCardModal() {
    document.getElementById('cardModalTitle').textContent = 'Add Card';
    document.getElementById('cardForm').reset();
    document.querySelector('[name="card_id"]').value = '';
    document.getElementById('cardModal').classList.remove('hidden');
}

function hideCardModal() {
    document.getElementById('cardModal').classList.add('hidden');
}

function editCard(card) {
    document.getElementById('cardModalTitle').textContent = 'Edit Card';
    document.querySelector('[name="card_id"]').value = card.id;
    document.querySelector('[name="name"]').value = card.name || '';
    document.querySelector('[name="emoji"]').value = card.emoji || '⚔️';
    document.querySelector('[name="description"]').value = card.description || '';
    document.querySelector('[name="attack"]').value = card.attack;
    document.querySelector('[name="hp"]').value = card.hp;
    document.querySelector('[name="ability"]').value = card.ability || '';
    document.getElementById('cardModal').classList.remove('hidden');
}

async function saveCard() {
    const form = document.getElementById('cardForm');
    const formData = new FormData(form);
    const cardId = formData.get('card_id');
    const data = Object.fromEntries(formData.entries());
    data.attack = parseInt(data.attack) || 10;
    data.hp = parseInt(data.hp) || 20;
    delete data.card_id;

    const url = cardId
        ? `/monsters/cards/${cardId}/update`
        : `/monsters/${monsterId}/cards/add`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function deleteCard(cardId) {
    if (!confirm('Are you sure you want to delete this card?')) return;

    try {
        const response = await fetch(`/monsters/cards/${cardId}/delete`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            document.getElementById('card-' + cardId).remove();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Close modal on backdrop click
document.getElementById('cardModal').addEventListener('click', function(e) {
    if (e.target === this) hideCardModal();
});
</script>
{% endblock %}
