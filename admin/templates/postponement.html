{% extends "base.html" %}

{% block title %}Task Postponement Monitor{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Task Postponement Monitor</h1>
        <span class="text-sm text-gray-500">Server time (MSK): {{ server_time.strftime('%Y-%m-%d %H:%M:%S') if server_time else 'N/A' }}</span>
    </div>

    <!-- Status cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <!-- Overdue count -->
        <div class="bg-white rounded-xl shadow p-5 border-l-4 {{ 'border-green-500' if overdue|length == 0 else 'border-red-500' }}">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Overdue Tasks</div>
            <div class="text-3xl font-bold {{ 'text-green-600' if overdue|length == 0 else 'text-red-600' }} mt-1">
                {{ overdue|length }}
            </div>
            <div class="text-xs text-gray-400 mt-1">
                {% if overdue|length == 0 %}
                    All tasks are on schedule
                {% else %}
                    Tasks with due_date &lt; today that were NOT postponed
                {% endif %}
            </div>
        </div>

        <!-- Last postponement run -->
        <div class="bg-white rounded-xl shadow p-5 border-l-4 border-blue-500">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Last Postponement</div>
            {% if logs|length > 0 %}
                <div class="text-lg font-bold text-gray-800 mt-1">
                    {{ logs[0].created_at.strftime('%b %d, %H:%M') if logs[0].created_at else 'N/A' }}
                </div>
                <div class="text-xs text-gray-400 mt-1">
                    {{ logs[0].tasks_postponed }} tasks for {{ logs[0].first_name or logs[0].username }}
                </div>
            {% else %}
                <div class="text-lg font-bold text-gray-400 mt-1">Never</div>
            {% endif %}
        </div>

        <!-- Cron schedule -->
        <div class="bg-white rounded-xl shadow p-5 border-l-4 border-purple-500">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Cron Schedule</div>
            <div class="text-lg font-bold text-gray-800 mt-1">00:05 MSK daily</div>
            <div class="text-xs text-gray-400 mt-1">
                + startup check on bot restart
            </div>
        </div>
    </div>

    <!-- Daily postponement chart (last 14 days) -->
    <div class="bg-white rounded-xl shadow p-5 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Daily Postponements (last 14 days)</h2>
        {% if daily_stats|length > 0 %}
        <div class="overflow-x-auto">
            <div class="flex items-end gap-1 h-40 min-w-[600px]">
                {% set max_tasks = daily_stats|map(attribute='tasks')|max %}
                {% for day in daily_stats %}
                <div class="flex-1 flex flex-col items-center gap-1">
                    <span class="text-xs text-gray-500">{{ day.tasks|int }}</span>
                    <div class="w-full bg-blue-500 rounded-t"
                         style="height: {{ ((day.tasks|int / (max_tasks|int if max_tasks|int > 0 else 1)) * 120)|int }}px;"
                         title="{{ day.date }}: {{ day.tasks|int }} tasks, {{ day.users }} users">
                    </div>
                    <span class="text-[10px] text-gray-400 -rotate-45 origin-top-left whitespace-nowrap mt-1">
                        {{ day.date.strftime('%m/%d') if day.date.strftime is defined else day.date }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <p class="text-gray-400 text-sm">No postponement data in the last 14 days.</p>
        {% endif %}
    </div>

    <!-- Task distribution by date -->
    <div class="bg-white rounded-xl shadow p-5 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Task Distribution (today &plusmn; 3 days)</h2>
        {% if task_dist|length > 0 %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2 px-3 text-gray-500">Date</th>
                        <th class="text-left py-2 px-3 text-gray-500">Status</th>
                        <th class="text-right py-2 px-3 text-gray-500">Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in task_dist %}
                    <tr class="border-b border-gray-100 {{ 'bg-yellow-50' if row.due_date.strftime is defined and row.due_date < server_time.date() else ('bg-green-50' if row.due_date == server_time.date() else '') }}">
                        <td class="py-2 px-3 font-mono">
                            {{ row.due_date.strftime('%Y-%m-%d') if row.due_date.strftime is defined else row.due_date }}
                            {% if row.due_date.strftime is defined and row.due_date < server_time.date() %}
                                <span class="text-red-500 text-xs ml-1">OVERDUE</span>
                            {% elif row.due_date == server_time.date() %}
                                <span class="text-green-500 text-xs ml-1">TODAY</span>
                            {% endif %}
                        </td>
                        <td class="py-2 px-3">
                            <span class="px-2 py-0.5 rounded text-xs
                                {{ 'bg-yellow-100 text-yellow-700' if row.status == 'pending' else
                                   ('bg-blue-100 text-blue-700' if row.status == 'in_progress' else
                                   ('bg-green-100 text-green-700' if row.status == 'completed' else 'bg-gray-100 text-gray-700')) }}">
                                {{ row.status }}
                            </span>
                        </td>
                        <td class="py-2 px-3 text-right font-semibold">{{ row.cnt }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-400 text-sm">No tasks in the date range.</p>
        {% endif %}
    </div>

    <!-- Overdue tasks (if any) -->
    {% if overdue|length > 0 %}
    <div class="bg-white rounded-xl shadow p-5 mb-6 border-2 border-red-200">
        <h2 class="text-lg font-semibold text-red-600 mb-4">Overdue Tasks (need attention)</h2>
        <table class="min-w-full text-sm">
            <thead>
                <tr class="border-b">
                    <th class="text-left py-2 px-3 text-gray-500">ID</th>
                    <th class="text-left py-2 px-3 text-gray-500">Title</th>
                    <th class="text-left py-2 px-3 text-gray-500">User</th>
                    <th class="text-left py-2 px-3 text-gray-500">Due Date</th>
                    <th class="text-left py-2 px-3 text-gray-500">Status</th>
                    <th class="text-left py-2 px-3 text-gray-500">Priority</th>
                </tr>
            </thead>
            <tbody>
                {% for task in overdue %}
                <tr class="border-b border-gray-100">
                    <td class="py-2 px-3 font-mono text-gray-500">{{ task.id }}</td>
                    <td class="py-2 px-3">{{ task.title[:50] }}</td>
                    <td class="py-2 px-3 text-gray-500">{{ task.first_name or task.username }}</td>
                    <td class="py-2 px-3 font-mono text-red-500">{{ task.due_date }}</td>
                    <td class="py-2 px-3">{{ task.status }}</td>
                    <td class="py-2 px-3">{{ task.priority }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Recent postpone logs -->
    <div class="bg-white rounded-xl shadow p-5">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Recent Postponement Logs</h2>
        {% if logs|length > 0 %}
        <table class="min-w-full text-sm">
            <thead>
                <tr class="border-b">
                    <th class="text-left py-2 px-3 text-gray-500">Date</th>
                    <th class="text-left py-2 px-3 text-gray-500">User</th>
                    <th class="text-right py-2 px-3 text-gray-500">Tasks</th>
                    <th class="text-left py-2 px-3 text-gray-500">Priority Changes</th>
                    <th class="text-center py-2 px-3 text-gray-500">Notified</th>
                    <th class="text-left py-2 px-3 text-gray-500">Timestamp</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-2 px-3 font-mono">{{ log.date }}</td>
                    <td class="py-2 px-3">{{ log.first_name or log.username }}</td>
                    <td class="py-2 px-3 text-right font-semibold">{{ log.tasks_postponed }}</td>
                    <td class="py-2 px-3 text-xs text-gray-500 max-w-xs truncate">
                        {% if log.priority_changes %}
                            {% set changes = log.priority_changes if log.priority_changes is iterable and log.priority_changes is not string else [] %}
                            {% for c in changes %}
                                <span class="inline-block bg-orange-100 text-orange-700 px-1 rounded mr-1">
                                    {{ c.old_priority }} &rarr; {{ c.new_priority }}
                                </span>
                            {% endfor %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="py-2 px-3 text-center">
                        {% if log.notified %}
                            <span class="text-green-500">&#10003;</span>
                        {% else %}
                            <span class="text-gray-300">&#10005;</span>
                        {% endif %}
                    </td>
                    <td class="py-2 px-3 text-xs text-gray-400">
                        {{ log.created_at.strftime('%m/%d %H:%M') if log.created_at else '' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-gray-400 text-sm">No postponement logs yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
